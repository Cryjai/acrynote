// Application Data with enhanced structure
const notesData = {
  "categories": {
    "ä¸­æ–‡": [
      {
        "id": "chinese_1",
        "title": "æ–‡è¨€æ–‡ç§˜ç¬ˆ",
        "content": "# æ–‡è¨€æ–‡çµ‚æ¥µæ”»ç•¥\n\nä¹‹ä¹è€…ä¹Ÿçµ‚æ¥µæ”»ç•¥ï¼ŒåŒ…æ‹¬å¸¸ç”¨è™›è©ã€å¯¦è©è§£æã€‚é‡é»æŒæ¡ï¼š\n\n![å¤ä»£æ›¸æ³•ç¤ºä¾‹](https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=500&h=300&fit=crop)\n\n## è™›è©è©³è§£\n\n### å¸¸ç”¨è™›è©åˆ†é¡\n- **ä¹‹**ï¼šåŠ©è©ã€ä»£è©ã€å‹•è©\n  - åŠ©è©ï¼šçš„ã€åœ°\n  - ä»£è©ï¼šä»–ã€å®ƒã€é€™\n  - å‹•è©ï¼šåˆ°ã€å¾€\n\n- **ä¹**ï¼šèªæ°£è©ã€ä»‹è©\n  - èªæ°£è©ï¼šå‘¢ã€å—\n  - ä»‹è©ï¼šæ–¼ã€åœ¨\n\n- **è€…**ï¼šä»£è©ã€åŠ©è©\n  - ä»£è©ï¼š...çš„äººã€...çš„äº‹ç‰©\n  - åŠ©è©ï¼šç”¨æ–¼å®šèªå¾Œ\n\n- **ä¹Ÿ**ï¼šèªæ°£è©ã€åˆ¤æ–·è©\n  - èªæ°£è©ï¼šå•Šã€å‘¢\n  - åˆ¤æ–·è©ï¼šæ˜¯\n\n[youtube:dQw4w9WgXcQ]\n\n## å¯¦è©é‡é»\n\n### é€šå‡å­—è¦å¾‹\né€šå‡å­—æ˜¯å¤ä»£ç”¨å­—ç¿’æ…£ï¼Œéœ€è¦æŒæ¡å¸¸è¦‹æ¨¡å¼ï¼š\n- éŸ³è¿‘é€šå‡ï¼šå¦‚ã€Œèš¤ã€é€šã€Œæ—©ã€\n- ç¾©è¿‘é€šå‡ï¼šå¦‚ã€Œäº¡ã€é€šã€Œç„¡ã€\n\n### å¤ä»Šç•°ç¾©è©\nè©ç¾©åœ¨æ­·å²ä¸­ç™¼ç”Ÿè®ŠåŒ–çš„è©èªï¼š\n- **å¦»å­**ï¼šå¤ç¾©æŒ‡å¦»å­å’Œå…’å¥³ï¼Œä»Šç¾©æŒ‡é…å¶\n- **å­¸è€…**ï¼šå¤ç¾©æŒ‡æ±‚å­¸çš„äººï¼Œä»Šç¾©æŒ‡æœ‰å­¸å•çš„äºº\n\n[file:æ–‡è¨€æ–‡è™›è©è¡¨.pdf](https://example.com/wenyanwen.pdf)\n\n## å¥å¼åˆ†æ\n\n### åˆ¤æ–·å¥\n- æ ¼å¼ï¼š...è€…...ä¹Ÿ\n- ä¾‹å¥ï¼šå»‰é —è€…ï¼Œè¶™ä¹‹è‰¯å°‡ä¹Ÿ\n\n### è¢«å‹•å¥\n- æ ¼å¼ï¼šè¦‹...æ–¼ã€ç‚º...æ‰€\n- ä¾‹å¥ï¼šå¾é•·è¦‹ç¬‘æ–¼å¤§æ–¹ä¹‹å®¶",
        "tags": ["æ–‡è¨€æ–‡", "è™›è©", "DSEä¸­æ–‡"]
      },
      {
        "id": "chinese_2",
        "title": "ä½œæ–‡ç¥æŠ€",
        "content": "# ä½œæ–‡çµ‚æ¥µæŠ€å·§\n\nè­°è«–æ–‡ä¸‰æ®µè«– + è¨˜æ•˜æ–‡æƒ…æ„Ÿæ¸²æŸ“æŠ€å·§\n\n![å¯«ä½œæŠ€å·§åœ–è§£](https://images.unsplash.com/photo-1455390582262-044cdead277a?w=500&h=300&fit=crop)\n\n## è­°è«–æ–‡çµæ§‹\n\n### å¼•è«–æŠ€å·§\n- **é–‹é–€è¦‹å±±æ³•**ï¼šç›´æ¥æå‡ºè«–é»\n- **å¼•ç”¨åè¨€æ³•**ï¼šå€Ÿåäººä¹‹å£å¢å¼·èªªæœåŠ›\n- **è¨­å•æ³•**ï¼šå¼•ç™¼è®€è€…æ€è€ƒ\n- **å°æ¯”æ³•**ï¼šé€šéå°æ¯”çªå‡ºè«–é»\n\n### æœ¬è«–å±•é–‹\næœ¬è«–æ˜¯æ–‡ç« çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œéœ€è¦ï¼š\n\n#### è«–è­‰æ–¹æ³•\n- **èˆ‰ä¾‹è«–è­‰**ï¼šç”¨å…·é«”äº‹ä¾‹è­‰æ˜è«–é»\n- **å¼•ç”¨è«–è­‰**ï¼šå¼•ç”¨æ¬Šå¨è¨€è«–æˆ–æ•¸æ“š\n- **å°æ¯”è«–è­‰**ï¼šé€šéæ­£åå°æ¯”èªªæ˜é“ç†\n- **æ¯”å–»è«–è­‰**ï¼šç”¨ç”Ÿå‹•æ¯”å–»èª¬æ˜æŠ½è±¡é“ç†\n\n#### è«–è­‰çµæ§‹\næ¯å€‹åˆ†è«–é»éƒ½æ‡‰è©²åŒ…å«ï¼š\n1. æå‡ºåˆ†è«–é»\n2. åˆ†æè«–è­‰\n3. èˆ‰ä¾‹èªªæ˜\n4. ç¸½çµå›æ‰£\n\n[audio:ä½œæ–‡æœ—è®€ç¤ºç¯„.mp3](https://example.com/zuowen_demo.mp3)\n\n## è¨˜æ•˜æ–‡æŠ€å·§\n\n### æƒ…æ„Ÿæ¸²æŸ“\nè¨˜æ•˜æ–‡çš„ç”Ÿå‘½åŠ›åœ¨æ–¼æƒ…æ„Ÿçš„çœŸæ‘¯è¡¨é”ï¼š\n\n#### ç´°ç¯€æå¯«\n- **å¤–è²Œæå¯«**ï¼šæŠ“ä½ç‰¹å¾µï¼Œçªå‡ºæ€§æ ¼\n- **å‹•ä½œæå¯«**ï¼šå±•ç¾äººç‰©å…§å¿ƒä¸–ç•Œ\n- **èªè¨€æå¯«**ï¼šå€‹æ€§åŒ–å°è©±ï¼Œæ¨é€²æƒ…ç¯€\n- **å¿ƒç†æå¯«**ï¼šç›´æ¥æ­ç¤ºå…§å¿ƒæ´»å‹•\n\n#### ç’°å¢ƒæ¸²æŸ“\n- **è‡ªç„¶ç’°å¢ƒ**ï¼šçƒ˜æ‰˜æ°£æ°›ï¼Œæš—ç¤ºæƒ…æ„Ÿ\n- **ç¤¾æœƒç’°å¢ƒ**ï¼šäº¤ä»£èƒŒæ™¯ï¼Œæ¨å‹•æƒ…ç¯€\n\n### çµæ§‹å®‰æ’\n- **é¦–å°¾å‘¼æ‡‰**ï¼šå‰å¾Œç…§æ‡‰ï¼Œçµæ§‹å®Œæ•´\n- **æ¬²æšå…ˆæŠ‘**ï¼šå…ˆæŠ‘å¾Œæšï¼Œå¢å¼·æ•ˆæœ\n- **æ’æ•˜å€’æ•˜**ï¼šè±å¯Œå…§å®¹ï¼Œå¢åŠ æ‡¸å¿µ",
        "tags": ["ä½œæ–‡", "è­°è«–æ–‡", "è¨˜æ•˜æ–‡"]
      }
    ],
    "è‹±æ–‡": [
      {
        "id": "english_1",
        "title": "Grammar Mastery",
        "content": "# Grammar Ultimate Guide\n\n**Present Perfect vs Past Simple çµ‚æ¥µæŒ‡å—ï¼š**\n\n[youtube:1Dax90QyXgI]\n\n## Present Perfect Tense\n\n### åŸºæœ¬æ¦‚å¿µ\nPresent Perfectç”¨æ–¼æè¿°éå»ç™¼ç”Ÿä½†èˆ‡ç¾åœ¨ç›¸é—œçš„å‹•ä½œæˆ–ç‹€æ…‹ã€‚\n\n#### æ§‹æˆæ–¹å¼\n- **å…¬å¼**: have/has + past participle\n- **ä¾‹å¥**: \n  - I have finished my homework.\n  - She has lived here for 5 years.\n\n#### ä½¿ç”¨æƒ…æ³\n1. **æœªå®Œæˆçš„å‹•ä½œ**ï¼šå¾éå»é–‹å§‹ï¼ŒæŒçºŒåˆ°ç¾åœ¨\n   - I have studied English for 10 years.\n\n2. **å‰›å®Œæˆçš„å‹•ä½œ**ï¼šå‰›å‰›å®Œæˆï¼Œå°ç¾åœ¨æœ‰å½±éŸ¿\n   - I have just eaten lunch.\n\n3. **äººç”Ÿç¶“æ­·**ï¼šåˆ°ç›®å‰ç‚ºæ­¢çš„ç¶“æ­·\n   - I have been to Japan twice.\n\n![Grammar Timeline](https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=500&h=300&fit=crop)\n\n## Past Simple Tense\n\n### åŸºæœ¬æ¦‚å¿µ\nPast Simpleç”¨æ–¼æè¿°éå»ç‰¹å®šæ™‚é–“å®Œæˆçš„å‹•ä½œã€‚\n\n#### æ§‹æˆæ–¹å¼\n- **è¦å‰‡å‹•è©**: å‹•è© + ed\n- **ä¸è¦å‰‡å‹•è©**: éœ€è¦è¨˜æ†¶ç‰¹æ®Šå½¢å¼\n\n#### é—œéµæ™‚é–“è©\n- yesterday, last week, in 2020, ago, when I was young\n\n### æ™‚æ…‹å°æ¯”\n\n#### Present Perfectæ¨™èªŒè©\n- already, just, yet, since, for, ever, never\n\n#### Past Simpleæ¨™èªŒè©\n- yesterday, last week, ago, in 1990, when\n\n[file:Grammar_Reference_Sheet.pdf](https://example.com/grammar.pdf)\n\n## è¨˜æ†¶æŠ€å·§\n\n### å£è¨£è¨˜æ†¶\n- **Present Perfect** = éå»+ç¾åœ¨é€£çµ\n- **Past Simple** = ç´”ç²¹éå»äº‹ä»¶\n\n### ç·´ç¿’å»ºè­°\n1. æ¯æ—¥é€ å¥ç·´ç¿’\n2. é–±è®€è‹±æ–‡æ–‡ç« ï¼Œæ³¨æ„æ™‚æ…‹ä½¿ç”¨\n3. èˆ‡native speakerå°è©±ç·´ç¿’",
        "tags": ["grammar", "tenses", "DSE English"]
      },
      {
        "id": "english_2",
        "title": "Essay Writing Formula",
        "content": "# Essay Writing Mastery\n\n**å®Œç¾Essayçµæ§‹å…¬å¼ï¼š**\n\n[youtube:8Ph06d2gI0Y]\n\n## Introduction Structure\n\n### Hook Techniques\né–‹å ´ç™½æ˜¯å¸å¼•è®€è€…çš„é—œéµï¼š\n\n#### å¸¸ç”¨Hooké¡å‹\n- **å¼•ç”¨åè¨€**: \"Education is the most powerful weapon which you can use to change the world.\" - Nelson Mandela\n- **é©šäººçµ±è¨ˆ**: Did you know that 95% of students struggle with essay writing?\n- **è¨­å•å¥**: What if I told you that writing a perfect essay is easier than you think?\n- **ç”Ÿå‹•å ´æ™¯**: Picture this: a student staring at a blank page, paralyzed by the fear of writing.\n\n![Essay Structure Diagram](https://images.unsplash.com/photo-1456324504439-367cee3b3c32?w=500&h=300&fit=crop)\n\n### Background Information\næä¾›å¿…è¦çš„èƒŒæ™¯è³‡è¨Šï¼Œå¹«åŠ©è®€è€…ç†è§£topic contextã€‚\n\n### Thesis Statement\nè«–æ–‡é™³è¿°æ˜¯essayçš„æ ¸å¿ƒï¼Œå¿…é ˆï¼š\n- æ˜ç¢ºè¡¨é”ä¸»è¦è«–é»\n- é å‘Šæ–‡ç« çµæ§‹\n- å…·æœ‰çˆ­è­°æ€§å’Œè¨è«–åƒ¹å€¼\n\n## Body Paragraph Structure\n\n### PEEL Method\næ¯å€‹Body Paragraphéƒ½æ‡‰è©²éµå¾ªPEELçµæ§‹ï¼š\n\n#### Point (è«–é»)\n- æ¸…æ™°æå‡ºåˆ†è«–é»\n- èˆ‡thesis statementå‘¼æ‡‰\n\n#### Evidence (è­‰æ“š)\n- æä¾›å…·é«”examples, statistics, quotes\n- ç¢ºä¿è­‰æ“šçš„å¯é æ€§å’Œç›¸é—œæ€§\n\n#### Explanation (è§£é‡‹)\n- åˆ†æè­‰æ“šå¦‚ä½•æ”¯æŒè«–é»\n- æ·±å…¥æ¢è¨å› æœé—œä¿‚\n\n#### Link (é€£çµ)\n- ç¸½çµæ®µè½è¦é»\n- éæ¸¡åˆ°ä¸‹ä¸€æ®µè½\n\n### Transition Words\næœ‰æ•ˆçš„éæ¸¡è©è®“æ–‡ç« æµæš¢ï¼š\n\n#### å› æœé—œä¿‚\n- Therefore, consequently, as a result, hence\n\n#### å°æ¯”é—œä¿‚\n- However, nevertheless, on the contrary, whereas\n\n#### è£œå……é—œä¿‚\n- Furthermore, moreover, additionally, in addition\n\n## Conclusion Strategies\n\n### çµè«–ä¸‰è¦ç´ \n1. **é‡ç”³Thesis**: ç”¨ä¸åŒæªè¾­é‡ç”³ä¸»è¦è«–é»\n2. **ç¸½çµè¦é»**: ç°¡æ½”æ¦‚æ‹¬ä¸»è¦è«–è­‰\n3. **Call to Action**: æå‡ºå»ºè­°æˆ–å‘¼ç±²è¡Œå‹•\n\n### çµè«–æŠ€å·§\n- å›åˆ°Hookå‘¼æ‡‰é–‹é ­\n- æå‡ºæ›´å»£æ³›çš„implications\n- ä»¥å¼·æœ‰åŠ›çš„statementçµå°¾\n\n[file:Essay_Templates.pdf](https://example.com/essay_templates.pdf)",
        "tags": ["essay", "writing", "structure"]
      }
    ],
    "Econ": [
      {
        "id": "econ_1",
        "title": "Supply & Demand Analysis",
        "content": "# Market Mechanisms\n\n**Market equilibrium analysis and price mechanisms:**\n\n![Supply and Demand Graph](https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=500&h=300&fit=crop)\n\n## Supply Analysis\n\n### Supply Curve Characteristics\nSupply curve shows the relationship between price and quantity supplied:\n\n#### Law of Supply\n- **åŸºæœ¬å®šå¾‹**: Price â†‘ â†’ Quantity Supplied â†‘\n- **åŸç†**: Higher prices provide greater incentive to produce\n- **ä¾‹å¤–**: Backward-bending supply curve for labour\n\n#### Supply Determinants\nFactors that shift the entire supply curve:\n\n##### Production Costs\n- Raw material prices\n- Labour costs\n- Technology improvements\n- Government subsidies/taxes\n\n##### Market Conditions\n- Number of sellers\n- Future price expectations\n- Seasonal factors\n\n[youtube:3ez10ADR_gM]\n\n## Demand Analysis\n\n### Demand Curve Properties\nDemand curve illustrates consumer behavior:\n\n#### Law of Demand\n- **åŸºæœ¬å®šå¾‹**: Price â†‘ â†’ Quantity Demanded â†“\n- **Income Effect**: Higher prices reduce purchasing power\n- **Substitution Effect**: Consumers switch to alternatives\n\n#### Demand Shifters\nNon-price factors affecting demand:\n\n##### Consumer Factors\n- Income levels (normal vs inferior goods)\n- Consumer preferences and trends\n- Population demographics\n- Future expectations\n\n##### Market Factors\n- Prices of substitutes and complements\n- Seasonal variations\n- Marketing and advertising effects\n\n## Market Equilibrium\n\n### Equilibrium Concept\nWhere supply meets demand (S = D):\n\n#### Price Mechanism\n- **Market-clearing price**: No shortage or surplus\n- **Automatic adjustment**: Prices adjust to balance supply and demand\n- **Efficiency**: Resources allocated optimally\n\n#### Disequilibrium Analysis\n- **Shortage**: Demand > Supply â†’ Price â†‘\n- **Surplus**: Supply > Demand â†’ Price â†“\n- **Market forces**: Automatic tendency toward equilibrium\n\n[file:Supply_Demand_Charts.pdf](https://example.com/supply_demand.pdf)\n\n### Consumer and Producer Surplus\n\n#### Consumer Surplus\n- Area below demand curve, above price\n- Represents consumer benefit\n- Welfare measure of consumer well-being\n\n#### Producer Surplus\n- Area above supply curve, below price\n- Represents producer profit\n- Measure of producer welfare\n\n#### Total Welfare\n- Sum of consumer and producer surplus\n- Maximized at market equilibrium\n- Deadweight loss from market inefficiency",
        "tags": ["microeconomics", "market", "DSE Econ"]
      },
      {
        "id": "econ_2",
        "title": "GDP and Economic Growth",
        "content": "# National Income Accounting\n\n**Nominal vs Real GDP, inflation adjustments:**\n\n![Economic Data Visualization](https://images.unsplash.com/photo-1590283603385-17ffb3a7f29f?w=500&h=300&fit=crop)\n\n## GDP Measurement\n\n### GDP Definition\nGross Domestic Product measures total economic output:\n\n#### Three Approaches\n1. **Production Approach**: Sum of value added\n2. **Income Approach**: Sum of factor incomes\n3. **Expenditure Approach**: C + I + G + (X-M)\n\n### Nominal vs Real GDP\n\n#### Nominal GDP\n- **å®šç¾©**: Current market prices\n- **è¨ˆç®—**: Î£(Price Ã— Quantity) for current year\n- **å•é¡Œ**: Affected by inflation\n- **ç”¨é€”**: Comparing different economies at same time\n\n#### Real GDP\n- **å®šç¾©**: Constant prices (inflation-adjusted)\n- **è¨ˆç®—**: Using base year prices\n- **å„ªé»**: Shows actual economic growth\n- **ç”¨é€”**: Comparing same economy over time\n\n### GDP Deflator\n\n#### Calculation\n**GDP Deflator = (Nominal GDP / Real GDP) Ã— 100**\n\n#### Interpretation\n- Measures overall price level changes\n- Broader than CPI (includes all goods/services)\n- Shows economy-wide inflation rate\n\n[file:GDP_Calculation_Worksheet.pdf](https://example.com/gdp_calc.pdf)\n\n## Economic Growth Analysis\n\n### Growth Rate Calculation\n\n#### Formula\n**Growth Rate = [(Real GDPâ‚‚ - Real GDPâ‚) / Real GDPâ‚] Ã— 100%**\n\n#### Per Capita Growth\n- Accounts for population changes\n- Better measure of living standards\n- Formula: GDP per capita = Total GDP / Population\n\n### Factors Affecting Growth\n\n#### Supply-Side Factors\n- Labour force quantity and quality\n- Capital stock and investment\n- Technological progress\n- Natural resources\n\n#### Demand-Side Factors\n- Consumption spending\n- Investment demand\n- Government expenditure\n- Net exports\n\n## Business Cycle Analysis\n\n### Cycle Phases\n\n#### Expansion\n- GDP growth above trend\n- Falling unemployment\n- Rising consumer confidence\n- Increasing investment\n\n#### Peak\n- Maximum GDP level\n- Full employment\n- Potential inflation pressure\n- Economic overheating risk\n\n#### Contraction/Recession\n- Negative GDP growth\n- Rising unemployment\n- Falling business confidence\n- Decreased investment\n\n#### Trough\n- Lowest GDP point\n- High unemployment\n- Economic recovery preparation\n- Policy intervention timing\n\n### Economic Indicators\n\n#### Leading Indicators\n- Stock market performance\n- Consumer confidence\n- New business formation\n- Employment trends\n\n#### Lagging Indicators\n- Unemployment rate\n- Corporate profits\n- Consumer debt levels\n- Interest rate changes",
        "tags": ["macroeconomics", "GDP", "inflation"]
      }
    ],
    "ä¸­å²": [
      {
        "id": "history_1",
        "title": "å”æœç››ä¸–ç ”ç©¶",
        "content": "# å”æœæ”¿æ²»ç¶“æ¿Ÿæ–‡åŒ–\n\n**è²è§€ä¹‹æ²»ã€é–‹å…ƒç››ä¸–æ”¿æ²»ç¶“æ¿Ÿæ–‡åŒ–ç‰¹è‰²ï¼š**\n\n![å”æœåœ°åœ–](https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=500&h=300&fit=crop)\n\n## æ”¿æ²»åˆ¶åº¦\n\n### ä¸­å¤®æ”¿åºœçµæ§‹\n\n#### ä¸‰çœå…­éƒ¨åˆ¶\nå”æœå®Œå–„äº†éš‹æœçš„ä¸‰çœå…­éƒ¨åˆ¶ï¼š\n\n##### ä¸‰çœè·èƒ½\n- **ä¸­æ›¸çœ**ï¼šèµ·è‰è©”æ›¸ï¼Œæ±ºç­–æ©Ÿæ§‹\n- **é–€ä¸‹çœ**ï¼šå¯©æ ¸è©”æ›¸ï¼Œç›£ç£æ©Ÿæ§‹\n- **å°šæ›¸çœ**ï¼šåŸ·è¡Œè©”æ›¸ï¼Œè¡Œæ”¿æ©Ÿæ§‹\n\n##### å…­éƒ¨åˆ†å·¥\n- **åéƒ¨**ï¼šäººäº‹ä»»å…\n- **æˆ¶éƒ¨**ï¼šè²¡æ”¿æ”¶æ”¯\n- **ç¦®éƒ¨**ï¼šæ•™è‚²ç§‘èˆ‰\n- **å…µéƒ¨**ï¼šè»äº‹ç®¡ç†\n- **åˆ‘éƒ¨**ï¼šå¸æ³•å¯©åˆ¤\n- **å·¥éƒ¨**ï¼šå·¥ç¨‹ç‡Ÿé€ \n\n#### ç§‘èˆ‰åˆ¶åº¦\n\n##### è€ƒè©¦ç§‘ç›®\n- **æ˜ç¶“ç§‘**ï¼šè€ƒè©¦ç¶“å…¸çŸ¥è­˜\n- **é€²å£«ç§‘**ï¼šè€ƒè©¦è©©è³¦æ–‡ç« \n- **åˆ¶èˆ‰ç§‘**ï¼šçš‡å¸ç‰¹è¨­è€ƒè©¦\n\n##### åˆ¶åº¦æ„ç¾©\n- æ‰“ç ´é–€ç¬¬è§€å¿µ\n- é¸æ‹”äººæ‰æ©Ÿåˆ¶\n- åŠ å¼·ä¸­å¤®é›†æ¬Š\n- ä¿ƒé€²ç¤¾æœƒæµå‹•\n\n[audio:å”è©©æœ—èª¦ç¤ºç¯„.mp3](https://example.com/tangshi.mp3)\n\n## ç¶“æ¿Ÿç™¼å±•\n\n### è¾²æ¥­ç¹æ¦®\n\n#### åœŸåœ°åˆ¶åº¦\n- **å‡ç”°åˆ¶**ï¼šåˆ†é…åœŸåœ°çµ¦è¾²æ°‘\n- **ç§Ÿåº¸èª¿åˆ¶**ï¼šè³¦ç¨…å¾µæ”¶åˆ¶åº¦\n- **åºœå…µåˆ¶**ï¼šè»äº‹èˆ‡è¾²æ¥­çµåˆ\n\n#### è¾²æ¥­æŠ€è¡“\n- çŠå…·æ”¹é€²ï¼ˆæ›²è½…çŠï¼‰\n- æ°´åˆ©å·¥ç¨‹å»ºè¨­\n- ä½œç‰©å“ç¨®æ”¹è‰¯\n- è¾²æ™‚å®‰æ’å„ªåŒ–\n\n### å•†æ¥­ç¹æ¦®\n\n#### çµ²ç¶¢ä¹‹è·¯\n- **é™¸ä¸Šçµ²ç¶¢ä¹‹è·¯**ï¼šé€£æ¥äºæ­å¤§é™¸\n- **æµ·ä¸Šçµ²ç¶¢ä¹‹è·¯**ï¼šé€šå¾€æ±å—äº\n- **å•†å“è²¿æ˜“**ï¼šçµ²ç¶¢ã€èŒ¶è‘‰ã€ç“·å™¨\n- **æ–‡åŒ–äº¤æµ**ï¼šå®—æ•™ã€è—è¡“ã€æŠ€è¡“\n\n#### è²¨å¹£åˆ¶åº¦\n- çµ±ä¸€è²¨å¹£æ¨™æº–\n- é–‹å…ƒé€šå¯¶æµé€š\n- ä¿¡ç”¨åˆ¶åº¦ç™¼å±•\n- å•†æ¥­ä¿¡è²¸å‡ºç¾\n\n## æ–‡åŒ–æˆå°±\n\n### è©©æ­Œé¼ç››\n\n#### ä»£è¡¨è©©äºº\n- **æç™½**ï¼šæµªæ¼«ä¸»ç¾©ä»£è¡¨\n  - ä»£è¡¨ä½œï¼šã€Šå°‡é€²é…’ã€‹ã€ã€Šèœ€é“é›£ã€‹\n  - é¢¨æ ¼ï¼šè±ªæ”¾ä¸ç¾ˆï¼Œæƒ³åƒè±å¯Œ\n\n- **æœç”«**ï¼šç¾å¯¦ä¸»ç¾©ä»£è¡¨\n  - ä»£è¡¨ä½œï¼šã€Šä¸‰åã€‹ã€ã€Šä¸‰åˆ¥ã€‹\n  - é¢¨æ ¼ï¼šæ†‚åœ‹æ†‚æ°‘ï¼Œæ²‰é¬±é “æŒ«\n\n- **ç™½å±…æ˜“**ï¼šæ–°æ¨‚åºœé‹å‹•\n  - ä»£è¡¨ä½œï¼šã€Šé•·æ¨æ­Œã€‹ã€ã€Šçµç¶è¡Œã€‹\n  - é¢¨æ ¼ï¼šé€šä¿—æ˜“æ‡‚ï¼Œé—œæ³¨æ°‘ç”Ÿ\n\n#### è©©æ­Œç‰¹è‰²\n- é¡Œæå»£æ³›å¤šæ¨£\n- è—è¡“æŠ€å·§æˆç†Ÿ\n- æ€æƒ³å…§å®¹è±å¯Œ\n- å½±éŸ¿å¾Œä¸–æ·±é \n\n### å®—æ•™æ–‡åŒ–\n\n#### ä½›æ•™èˆˆç››\n- å¯ºé™¢ç¶“æ¿Ÿç™¼é”\n- ä½›æ•™è—è¡“ç¹æ¦®\n- ç„å¥˜è¥¿è¡Œå–ç¶“\n- ä½›æ•™ä¸­åœ‹åŒ–é€²ç¨‹\n\n#### é“æ•™ç™¼å±•\n- çš‡å®¤æ‰¶æŒé“æ•™\n- é“æ•™ç†è«–å®Œå–„\n- ç…‰ä¸¹è¡“ç™¼å±•\n- é¤Šç”Ÿæ–‡åŒ–èˆˆèµ·\n\n[file:å”æœå¹´è¡¨.pdf](https://example.com/tang_timeline.pdf)\n\n### å°å¤–é–‹æ”¾\n\n#### å¤–äº¤æ”¿ç­–\n- å†Šå°åˆ¶åº¦å®Œå–„\n- å’Œè¦ªæ”¿ç­–å¯¦æ–½\n- æœè²¢é«”ç³»å»ºç«‹\n- æ–‡åŒ–äº¤æµé »ç¹\n\n#### åœ‹éš›åœ°ä½\n- äºæ´²æ”¿æ²»ä¸­å¿ƒ\n- ç¶“æ¿Ÿæ–‡åŒ–å¼·åœ‹\n- å¤–åœ‹ä½¿ç¯€é›²é›†\n- ç•™å­¸ç”Ÿç´›è‡³æ²“ä¾†",
        "tags": ["å”æœ", "æ”¿æ²»", "ç¶“æ¿Ÿ"]
      },
      {
        "id": "history_2",
        "title": "æ˜æ¸…æ”¿æ²»è®Šé·",
        "content": "# æ˜æ¸…åˆ¶åº¦æ¼”è®Š\n\n**æ˜æœ«æ¸…åˆæ”¿æ²»åˆ¶åº¦è®ŠåŒ–èˆ‡å½±éŸ¿ï¼š**\n\n![æ˜æ¸…å®®æ®¿å»ºç¯‰](https://images.unsplash.com/photo-1548013146-72479768bada?w=500&h=300&fit=crop)\n\n## æ˜æœæ”¿æ²»åˆ¶åº¦\n\n### ä¸­å¤®é›†æ¬ŠåŠ å¼·\n\n#### å»¢é™¤ä¸ç›¸åˆ¶\næœ±å…ƒç’‹å»¢é™¤ä¸ç›¸åˆ¶åº¦çš„å½±éŸ¿ï¼š\n\n##### åˆ¶åº¦è®ŠåŒ–\n- **1380å¹´**ï¼šèƒ¡æƒŸåº¸æ¡ˆå¾Œå»¢é™¤ä¸­æ›¸çœ\n- **æ¬ŠåŠ›é›†ä¸­**ï¼šçš‡å¸ç›´æ¥ç®¡ç†å…­éƒ¨\n- **å…§é–£å‡ºç¾**ï¼šå”åŠ©çš‡å¸è™•ç†æ”¿å‹™\n- **ç¥¨æ“¬åˆ¶åº¦**ï¼šå…§é–£æå‡ºè™•ç†æ„è¦‹\n\n##### å…§é–£åˆ¶åº¦ç™¼å±•\n- **æ´ªæ­¦å¾ŒæœŸ**ï¼šè¨­ç«‹æ–‡æ·µé–£\n- **æ°¸æ¨‚æ™‚æœŸ**ï¼šå…§é–£åˆ¶åº¦åŒ–\n- **æˆåŒ–ä»¥å¾Œ**ï¼šé¦–è¼”åˆ¶åº¦ç¢ºç«‹\n- **æ˜æœ«æœŸé–“**ï¼šå…§é–£é»¨çˆ­æ¿€çƒˆ\n\n#### å» è¡åˆ¶åº¦\n\n##### ç‰¹å‹™æ©Ÿæ§‹\n- **éŒ¦è¡£è¡**ï¼šçš‡å¸è¦ªè»ï¼Œè² è²¬åµç·\n- **æ±å» **ï¼šå®¦å®˜ä¸»ç®¡ï¼Œç›£è¦–ç™¾å®˜\n- **è¥¿å» **ï¼šçŸ­æœŸè¨­ç«‹ï¼Œæ¬ŠåŠ›æ¥µå¤§\n- **å…§è¡Œå» **ï¼šæ˜æœ«è¨­ç«‹ï¼Œå¾Œè¢«å»¢é™¤\n\n##### åˆ¶åº¦å½±éŸ¿\n- åŠ å¼·çš‡æ¬Šçµ±æ²»\n- ç›£è¦–å®˜å“¡ç™¾å§“\n- é€ æˆææ€–æ”¿æ²»\n- å½±éŸ¿æ”¿æ²»æ¸…æ˜\n\n[youtube:kJQP7kiw5Fk]\n\n### åœ°æ–¹è¡Œæ”¿\n\n#### ä¸‰å¸åˆ†æ¬Š\n- **æ‰¿å®£å¸ƒæ”¿ä½¿å¸**ï¼šæ°‘æ”¿ç®¡ç†\n- **æåˆ‘æŒ‰å¯Ÿä½¿å¸**ï¼šå¸æ³•ç›£å¯Ÿ\n- **éƒ½æŒ‡æ®ä½¿å¸**ï¼šè»äº‹ç®¡ç†\n\n#### åˆ†æ¬Šç›®çš„\n- é˜²æ­¢åœ°æ–¹å‰²æ“š\n- åŠ å¼·ä¸­å¤®æ§åˆ¶\n- ç›¸äº’åˆ¶è¡¡ç›£ç£\n- æé«˜è¡Œæ”¿æ•ˆç‡\n\n## æ¸…æœæ”¿æ²»åˆ¶åº¦\n\n### æ»¿æ¼¢ä¸¦ç”¨æ”¿ç­–\n\n#### åˆ¶åº¦è¨­è¨ˆ\næ¸…æœåœ¨æ”¿æ²»åˆ¶åº¦ä¸Šæ¡å–æ»¿æ¼¢ä¸¦ç”¨ï¼š\n\n##### ä¸­å¤®æ”¿åºœ\n- **è­°æ”¿ç‹å¤§è‡£æœƒè­°**ï¼šæ¸…åˆæœ€é«˜æ±ºç­–æ©Ÿæ§‹\n- **å…§ä¸‰é™¢**ï¼šæ•ˆä»¿æ˜æœå…§é–£åˆ¶åº¦\n- **å…­éƒ¨åˆ¶**ï¼šæ‰¿è¥²æ˜æœè¡Œæ”¿é«”ç³»\n- **ç†è—©é™¢**ï¼šå°ˆç®¡è’™å¤ã€è¥¿è—äº‹å‹™\n\n##### è»æ©Ÿè™•è¨­ç«‹\n- **é›æ­£æ™‚æœŸ**ï¼šè¨­ç«‹è»æ©Ÿè™•\n- **è·èƒ½**ï¼šå”åŠ©çš‡å¸è™•ç†è»åœ‹å¤§äº‹\n- **ç‰¹é»**ï¼šæ•ˆç‡é«˜ã€ä¿å¯†æ€§å¼·\n- **å½±éŸ¿**ï¼šé€²ä¸€æ­¥å¼·åŒ–çš‡æ¬Š\n\n### å…«æ——åˆ¶åº¦\n\n#### çµ„ç¹”çµæ§‹\n- **æ»¿æ´²å…«æ——**ï¼šæ»¿æ—æ ¸å¿ƒåŠ›é‡\n- **è’™å¤å…«æ——**ï¼šè¯ç›Ÿè’™å¤éƒ¨æ—\n- **æ¼¢è»å…«æ——**ï¼šæ­¸é™æ¼¢äººè»éšŠ\n\n#### ç¤¾æœƒåŠŸèƒ½\n- è»äº‹çµ„ç¹”åŸºç¤\n- ç¤¾æœƒç®¡ç†å–®ä½\n- ç¶“æ¿Ÿä¾›é¤Šé«”ç³»\n- èº«åˆ†ç­‰ç´šæ¨™è­˜\n\n### ç§‘èˆ‰åˆ¶åº¦æ”¹é©\n\n#### åˆ¶åº¦èª¿æ•´\n- ä¿ç•™ç§‘èˆ‰è€ƒè©¦\n- å¢åŠ æ»¿æ–‡è€ƒè©¦\n- è¨­ç«‹ç¿»è­¯ç§‘ç›®\n- é™åˆ¶æ¼¢äººåé¡\n\n#### æ–‡å­—æ”¿ç­–\n- æ¨è¡Œæ»¿æ–‡æ•™è‚²\n- å®˜æ–¹æ–‡æ›¸é›™èª\n- ä¿è­·æ»¿æ—æ–‡åŒ–\n- é˜²ç¯„æ¼¢åŒ–å½±éŸ¿\n\n[file:æ˜æ¸…æ”¿æ²»åˆ¶åº¦å°æ¯”è¡¨.pdf](https://example.com/mingqing_compare.pdf)\n\n## æ”¿æ²»åˆ¶åº¦å½±éŸ¿\n\n### ä¸­å¤®é›†æ¬Šå¼·åŒ–\n\n#### ç©æ¥µå½±éŸ¿\n- åœ‹å®¶çµ±ä¸€ç©©å®š\n- æ”¿ä»¤çµ±ä¸€æœ‰æ•ˆ\n- ç¶“æ¿Ÿç™¼å±•ä¿ƒé€²\n- æ–‡åŒ–äº¤æµé »ç¹\n\n#### æ¶ˆæ¥µå½±éŸ¿\n- å°ˆåˆ¶ç¨‹åº¦åŠ æ·±\n- å®˜åƒšè…æ•—åš´é‡\n- ç¤¾æœƒæ´»åŠ›æ¸›å¼±\n- å‰µæ–°èƒ½åŠ›ä¸‹é™\n\n### æ»¿æ¼¢é—œä¿‚\n\n#### æ”¿æ²»å®‰æ’\n- æ»¿æ¼¢å®˜å“¡ä¸¦ç”¨\n- é—œéµè·ä½æ»¿äºº\n- åˆ¶è¡¡æ”¿ç­–å¯¦æ–½\n- æ–‡åŒ–èåˆä¿ƒé€²\n\n#### ç¤¾æœƒçŸ›ç›¾\n- æ°‘æ—çŸ›ç›¾å­˜åœ¨\n- ç­‰ç´šåˆ¶åº¦æ£®åš´\n- åæ¸…å‹¢åŠ›æŒçºŒ\n- æ–‡åŒ–è¡çªæ™‚ç¾\n\n### ç¾ä»£åŒ–é€²ç¨‹\n\n#### åˆ¶åº¦åƒµåŒ–\n- æ”¿æ²»é«”åˆ¶ä¿å®ˆ\n- æ”¹é©é˜»åŠ›å·¨å¤§\n- è¥¿æ–¹è¡æ“ŠåŠ‡çƒˆ\n- è¿‘ä»£åŒ–æ»¯å¾Œ\n\n#### è®Šé©éœ€æ±‚\n- æ”¿æ²»æ°‘ä¸»åŒ–\n- ç¶“æ¿Ÿç¾ä»£åŒ–\n- æ–‡åŒ–é–‹æ”¾æ€§\n- ç¤¾æœƒå¹³ç­‰æ€§",
        "tags": ["æ˜æ¸…", "æ”¿æ²»åˆ¶åº¦", "è®Šé·"]
      }
    ]
  }
};

// Tag type mapping for colors
const tagTypes = {
  // Subject tags - Cyan
  'æ–‡è¨€æ–‡': 'cyan',
  'grammar': 'cyan',
  'microeconomics': 'cyan',
  'macroeconomics': 'cyan',
  'å”æœ': 'cyan',
  'æ˜æ¸…': 'cyan',
  
  // Skill tags - Purple  
  'è™›è©': 'purple',
  'ä½œæ–‡': 'purple',
  'è­°è«–æ–‡': 'purple',
  'è¨˜æ•˜æ–‡': 'purple',
  'phrases': 'purple',
  'vocab': 'purple',
  'tenses': 'purple',
  'essay': 'purple',
  'writing': 'purple',
  'structure': 'purple',
  'market': 'purple',
  'GDP': 'purple',
  'inflation': 'purple',
  'æ”¿æ²»': 'purple',
  'ç¶“æ¿Ÿ': 'purple',
  'æ”¿æ²»åˆ¶åº¦': 'purple',
  'è®Šé·': 'purple',
  
  // Exam tags - Orange
  'DSEä¸­æ–‡': 'orange',
  'DSE English': 'orange',
  'DSE Econ': 'orange'
};

// Application State
let currentCategory = 'ä¸­æ–‡';
let allNotes = {};
let filteredNotes = {};
let headerCollapseStates = new Map(); // Track collapse state of headers

// DOM Elements - Initialize after DOM is loaded
let tabButtons, categoryContents, searchInput, copyNotification, addNoteBtn;

// Initialize Application
document.addEventListener('DOMContentLoaded', function() {
    // Initialize DOM elements
    tabButtons = document.querySelectorAll('.tab-button');
    categoryContents = document.querySelectorAll('.category-content');
    searchInput = document.getElementById('searchInput');
    copyNotification = document.getElementById('copyNotification');
    addNoteBtn = document.getElementById('addNoteBtn');
    
    // Load notes data
    loadNotesData();
    
    // Render initial category
    renderCategory(currentCategory);
    
    // Setup event listeners
    setupEventListeners();
    
    // Add floating particles
    createFloatingParticles();
    
    // Add transition effects
    addTransitionEffects();
});

// Load and organize notes data
function loadNotesData() {
    allNotes = notesData.categories;
    filteredNotes = JSON.parse(JSON.stringify(allNotes)); // Deep copy
}

// Setup Event Listeners
function setupEventListeners() {
    // Tab switching
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const category = button.dataset.category;
            switchCategory(category);
        });
    });

    // Search functionality with debouncing
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = e.target.value.toLowerCase().trim();
                filterNotes(query);
            }, 200);
        });
    }

    // Add note button
    if (addNoteBtn) {
        addNoteBtn.addEventListener('click', () => {
            showNotification('åŠŸèƒ½é–‹ç™¼ä¸­... è«‹ç›´æ¥ä¿®æ”¹ app.js æ·»åŠ æ–°ç­†è¨˜ï¼', 3000);
        });
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + F to focus search
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            if (searchInput) searchInput.focus();
        }
        
        // ESC to clear search
        if (e.key === 'Escape' && searchInput && searchInput === document.activeElement) {
            searchInput.value = '';
            filterNotes('');
        }
    });
}

function parseContent(content) {
    let parsed = content;
    // åœ–ç‰‡ inline
    parsed = parsed.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,
        '<div class="image-container"><img src="$2" alt="$1" class="note-image" loading="lazy"></div>');
    // YouTube inline
    parsed = parsed.replace(/\[youtube:([^\]]+)\]/g,
        '<div class="youtube-container"><iframe src="https://www.youtube.com/embed/$1" frameborder="0" allowfullscreen class="youtube-video"></iframe></div>');
    // PDF inline
    parsed = parsed.replace(/\[file:([^\]]*)\]\(([^)]+)\)/g,
        '<div class="file-container"><embed src="$2" type="application/pdf" class="pdf-viewer"><p>PDF: <a href="$2" target="_blank">$1</a></p></div>');
    // Audio inline
    parsed = parsed.replace(/\[audio:([^\]]*)\]\(([^)]+)\)/g,
        '<div class="audio-container"><audio controls class="audio-player"><source src="$2" type="audio/mpeg">Your browser does not support audio.</audio><p>ğŸµ $1</p></div>');
    // Markdown
    parsed = parsed.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    parsed = parsed.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    parsed = parsed.replace(/\n/g, '<br>');
    return parsed;
}


// Switch Category
function switchCategory(category) {
    if (category === currentCategory) return;

    // Update tab buttons
    tabButtons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.category === category) {
            btn.classList.add('active');
        }
    });

    // Update content visibility with smooth transition
    categoryContents.forEach(content => {
        content.classList.remove('active');
        if (content.dataset.category === category) {
            // Small delay for smooth transition
            setTimeout(() => {
                content.classList.add('active');
            }, 100);
        }
    });

    currentCategory = category;
    
    // Clear search
    if (searchInput) {
        searchInput.value = '';
    }
    filterNotes('');
    
    // Render new category
    renderCategory(category);
}

// Render Category Notes
function renderCategory(category) {
    const container = document.getElementById(`notes-${category}`);
    const notes = filteredNotes[category] || [];
    
    if (!container) return;
    
    container.innerHTML = '';
    
    if (notes.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ”</div>
                <p style="font-size: 1.1rem;">æ²’æœ‰æ‰¾åˆ°ç›¸é—œç­†è¨˜</p>
                <p style="font-size: 0.9rem; margin-top: 0.5rem;">è©¦è©¦å…¶ä»–é—œéµå­—æˆ–åˆ‡æ›åˆ†é¡</p>
            </div>
        `;
        return;
    }
    
    notes.forEach((note, index) => {
        const noteCard = createNoteCard(note);
        noteCard.style.animationDelay = `${index * 0.1}s`;
        container.appendChild(noteCard);
    });
}

// Create Note Card
function createNoteCard(note) {
    const card = document.createElement('div');
    card.className = 'note-card';
    card.dataset.noteId = note.id;
    
    const formattedContent = formatMarkdownWithCollapse(note.content, note.id);
    const tagsHtml = createTagsHtml(note.tags);
    
    card.innerHTML = `
        <div class="note-header">
            <h3 class="note-title">${escapeHtml(note.title)}</h3>
            <div class="note-actions">
                <button class="action-btn copy-btn" title="è¤‡è£½å…§å®¹">
                    ğŸ“‹
                </button>
                <button class="action-btn expand-btn" title="å±•é–‹/æ”¶èµ·">
                    <span class="expand-icon">ğŸ”½</span>
                </button>
            </div>
        </div>
        <div class="note-content">
            <div class="note-text">${formattedContent}</div>
            <div class="note-tags">${tagsHtml}</div>
        </div>
    `;
    
    // Add event listeners to the card
    const noteHeader = card.querySelector('.note-header');
    const copyBtn = card.querySelector('.copy-btn');
    const expandBtn = card.querySelector('.expand-btn');
    
    // Note expansion toggle
    noteHeader.addEventListener('click', (e) => {
        // Don't trigger expansion if clicking on action buttons
        if (!e.target.closest('.action-btn')) {
            toggleNoteExpansion(note.id);
        }
    });
    
    // Copy functionality with attribution
    copyBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        copyNoteContentWithAttribution(note.id, e);
    });
    
    // Expand button
    expandBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleNoteExpansion(note.id);
    });
    
    // Setup collapsible headers after card is created
    setTimeout(() => setupCollapsibleHeaders(card, note.id), 100);
    
    return card;
}

// Setup Collapsible Headers
function setupCollapsibleHeaders(card, noteId) {
    const headers = card.querySelectorAll('h1, h2, h3, .header-h1, .header-h2, .header-h3');
    
    headers.forEach((header, index) => {
        const headerLevel = getHeaderLevel(header);
        const headerId = `${noteId}-header-${index}`;
        const collapseKey = headerId;
        
        // Skip if already processed
        if (header.classList.contains('collapsible-header')) return;
        
        // Add collapsible class and structure
        header.classList.add('collapsible-header');
        header.dataset.headerId = headerId;
        
        // Create collapse icon
        const collapseIcon = document.createElement('span');
        collapseIcon.className = 'collapse-icon';
        collapseIcon.innerHTML = 'â–¼';
        collapseIcon.title = 'é»æ“Šæ”¶èµ·/å±•é–‹';
        
        // Insert collapse icon at the beginning
        header.insertBefore(collapseIcon, header.firstChild);
        
        // Find content to collapse (everything until next header of same or higher level)
        const contentToCollapse = getHeaderContent(header, headerLevel);
        
        if (contentToCollapse.length > 0) {
            // Wrap content in collapsible container
            const collapseContainer = document.createElement('div');
            collapseContainer.className = 'collapsible-content';
            collapseContainer.dataset.headerId = headerId;
            
            // Move content into container
            contentToCollapse.forEach(element => {
                collapseContainer.appendChild(element);
            });
            
            // Insert container after header
            header.parentNode.insertBefore(collapseContainer, header.nextSibling);
            
            // Add click event to header
            header.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                toggleHeaderCollapse(headerId);
            });
            
            // Restore collapse state if exists
            const isCollapsed = headerCollapseStates.get(collapseKey);
            if (isCollapsed) {
                header.classList.add('collapsed');
                collapseContainer.classList.add('collapsed');
                collapseIcon.innerHTML = 'â–¶';
            }
        }
    });
}

// Get Header Level
function getHeaderLevel(header) {
    const tagName = header.tagName.toLowerCase();
    if (tagName === 'h1' || header.classList.contains('header-h1')) return 1;
    if (tagName === 'h2' || header.classList.contains('header-h2')) return 2;
    if (tagName === 'h3' || header.classList.contains('header-h3')) return 3;
    return 1;
}

// Get Header Content
function getHeaderContent(header, headerLevel) {
    const contentElements = [];
    let nextElement = header.nextElementSibling;
    
    while (nextElement) {
        const nextLevel = getHeaderLevel(nextElement);
        const isHeader = nextElement.tagName.match(/^H[1-3]$/i) || 
                        nextElement.classList.contains('header-h1') ||
                        nextElement.classList.contains('header-h2') ||
                        nextElement.classList.contains('header-h3');
        
        // Stop if we hit a header of same or higher level
        if (isHeader && nextLevel <= headerLevel) {
            break;
        }
        
        // Skip if it's already a collapsible-content container
        if (nextElement.classList.contains('collapsible-content')) {
            nextElement = nextElement.nextElementSibling;
            continue;
        }
        
        contentElements.push(nextElement);
        const current = nextElement;
        nextElement = nextElement.nextElementSibling;
        
        // Remove from DOM temporarily
        current.remove();
    }
    
    return contentElements;
}

// Toggle Header Collapse
function toggleHeaderCollapse(headerId) {
    const header = document.querySelector(`[data-header-id="${headerId}"]`);
    const content = document.querySelector(`.collapsible-content[data-header-id="${headerId}"]`);
    const icon = header?.querySelector('.collapse-icon');
    
    if (!header || !content) return;
    
    const isCurrentlyCollapsed = header.classList.contains('collapsed');
    
    if (isCurrentlyCollapsed) {
        // Expand
        header.classList.remove('collapsed');
        content.classList.remove('collapsed');
        if (icon) icon.innerHTML = 'â–¼';
        headerCollapseStates.delete(headerId);
    } else {
        // Collapse
        header.classList.add('collapsed');
        content.classList.add('collapsed');
        if (icon) icon.innerHTML = 'â–¶';
        headerCollapseStates.set(headerId, true);
    }
}

// Create Tags HTML
function createTagsHtml(tags) {
    return tags.map(tag => {
        const tagType = tagTypes[tag] || 'cyan';
        return `<span class="tag tag--${tagType}" data-tag="${escapeHtml(tag)}">${escapeHtml(tag)}</span>`;
    }).join('');
}

// Filter by tag (add event listeners after rendering)
function attachTagListeners() {
    document.querySelectorAll('.tag').forEach(tag => {
        tag.addEventListener('click', (e) => {
            e.stopPropagation();
            const tagText = e.target.dataset.tag;
            filterByTag(tagText);
        });
    });
}

// Filter by tag
function filterByTag(tag) {
    if (searchInput) {
        searchInput.value = tag;
    }
    filterNotes(tag.toLowerCase());
    showNotification(`æ­£åœ¨æœå°‹æ¨™ç±¤ï¼š${tag}`, 1500);
}

// Toggle Note Expansion
function toggleNoteExpansion(noteId) {
    const card = document.querySelector(`[data-note-id="${noteId}"]`);
    if (!card) return;
    
    const isExpanded = card.classList.contains('expanded');
    card.classList.toggle('expanded');
    
    // Update expand icon
    const expandIcon = card.querySelector('.expand-icon');
    if (expandIcon) {
        expandIcon.textContent = isExpanded ? 'ğŸ”½' : 'ğŸ”¼';
    }
    
    // Smooth scroll to card if expanding
    if (!isExpanded) {
        setTimeout(() => {
            card.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest' 
            });
        }, 200);
    }
}

// Copy Note Content with Acry CEO Attribution
async function copyNoteContentWithAttribution(noteId, event) {
    // Find the note content
    const note = findNoteById(noteId);
    if (!note) return;
    
    // Add attribution to content
    const attribution = "\n\n---\nPowered by Acry CEO, GitHub https://github.com/Cryjai";
    const contentWithAttribution = note.content + attribution;
    
    try {
        await navigator.clipboard.writeText(contentWithAttribution);
        
        // Show success notification with attribution message
        showNotification('å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ (å«Acry CEOç½²å)', 2500);
        
        // Visual feedback on button
        const button = event.currentTarget;
        const originalIcon = button.textContent;
        const originalColor = button.style.color;
        
        button.textContent = 'âœ…';
        button.style.color = 'var(--cyber-primary)';
        button.style.transform = 'scale(1.2)';
        
        setTimeout(() => {
            button.textContent = originalIcon;
            button.style.color = originalColor;
            button.style.transform = '';
        }, 1500);
        
    } catch (err) {
        console.error('Failed to copy text: ', err);
        
        // Fallback: try to select text using older method
        try {
            const textArea = document.createElement('textarea');
            textArea.value = contentWithAttribution;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);
            
            if (successful) {
                showNotification('å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ (å«Acry CEOç½²å)', 2500);
                
                // Visual feedback on button
                const button = event.currentTarget;
                const originalIcon = button.textContent;
                button.textContent = 'âœ…';
                button.style.color = 'var(--cyber-primary)';
                
                setTimeout(() => {
                    button.textContent = originalIcon;
                    button.style.color = '';
                }, 1500);
            } else {
                throw new Error('execCommand failed');
            }
        } catch (fallbackErr) {
            showNotification('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸æ“‡æ–‡å­—è¤‡è£½', 3000);
            console.error('Fallback copy failed: ', fallbackErr);
        }
    }
}

// Find Note by ID
function findNoteById(noteId) {
    for (const category in allNotes) {
        const note = allNotes[category].find(n => n.id === noteId);
        if (note) return note;
    }
    return null;
}

// Filter Notes
function filterNotes(query) {
    if (!query) {
        filteredNotes = JSON.parse(JSON.stringify(allNotes));
    } else {
        filteredNotes = {};
        for (const category in allNotes) {
            filteredNotes[category] = allNotes[category].filter(note =>
                note.title.toLowerCase().includes(query) ||
                note.content.toLowerCase().includes(query) ||
                note.tags.some(tag => tag.toLowerCase().includes(query))
            );
        }
    }
    
    renderCategory(currentCategory);
    
    // Attach tag listeners after rendering
    setTimeout(attachTagListeners, 100);
    
    // Show search result count
    if (query) {
        updateSearchResultCount(query);
    }
}

// Update search result count
function updateSearchResultCount(query) {
    const totalResults = Object.values(filteredNotes).reduce((sum, notes) => sum + notes.length, 0);
    
    if (totalResults > 0) {
        showNotification(`æ‰¾åˆ° ${totalResults} å€‹ç›¸é—œç­†è¨˜`, 1500);
    } else {
        showNotification('æ²’æœ‰æ‰¾åˆ°ç›¸é—œç­†è¨˜', 2000);
    }
}

// Format Markdown-like Content with Multimedia Support
function formatMarkdownWithCollapse(content, noteId) {
    let html = escapeHtml(content);
    
    // Process multimedia content first
    html = processMultimedia(html);
    
    // Headers with typography hierarchy
    html = html.replace(/^# (.*$)/gm, '<h1 class="header-h1">$1</h1>');
    html = html.replace(/^## (.*$)/gm, '<h2 class="header-h2">$1</h2>');
    html = html.replace(/^### (.*$)/gm, '<h3 class="header-h3">$1</h3>');
    html = html.replace(/^#### (.*$)/gm, '<h3 class="header-h3">$1</h3>');
    html = html.replace(/^##### (.*$)/gm, '<h3 class="header-h3">$1</h3>');
    
    // Bold text
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Lists
    html = html.replace(/^- (.*$)/gm, '<li>$1</li>');
    html = html.replace(/^(\d+)\. (.*$)/gm, '<li>$2</li>');
    
    // Wrap consecutive list items in ul
    html = html.replace(/(<li>.*?<\/li>(\s*\n)*)+/gs, (match) => {
        return '<ul>' + match.trim() + '</ul>\n';
    });
    
    // Line breaks to paragraphs
    html = html.replace(/\n\n+/g, '</p><p>');
    html = html.replace(/\n/g, '<br>');
    
    // Wrap in paragraphs if not already wrapped
    if (!html.startsWith('<h1>') && !html.startsWith('<h2>') && !html.startsWith('<h3>') && 
        !html.startsWith('<ul>') && !html.startsWith('<div class="multimedia-content">')) {
        html = '<p>' + html + '</p>';
    }
    
    // Clean up empty paragraphs
    html = html.replace(/<p><\/p>/g, '');
    html = html.replace(/<p>(\s*<br>\s*)*<\/p>/g, '');
    
    return html;
}

// Process Multimedia Content
function processMultimedia(html) {
    // Process images
    html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, alt, src) => {
        return `<div class="multimedia-content">
            <span class="media-icon">ğŸ–¼ï¸</span>
            <p><strong>åœ–ç‰‡: ${alt || 'Image'}</strong></p>
            <a href="${src}" target="_blank">æŸ¥çœ‹åœ–ç‰‡</a>
        </div>`;
    });
    
    // Process YouTube videos
    html = html.replace(/\[youtube:([^\]]+)\]/g, (match, videoId) => {
        return `<div class="multimedia-content">
            <span class="media-icon">ğŸ“º</span>
            <p><strong>YouTube å½±ç‰‡</strong></p>
            <a href="https://www.youtube.com/watch?v=${videoId}" target="_blank">è§€çœ‹å½±ç‰‡</a>
        </div>`;
    });
    
    // Process PDF files
    html = html.replace(/\[file:([^\]]+)\]\(([^)]+)\)/g, (match, fileName, fileUrl) => {
        const fileIcon = fileName.toLowerCase().includes('.pdf') ? 'ğŸ“„' : 
                        fileName.toLowerCase().includes('.doc') ? 'ğŸ“' : 'ğŸ“';
        return `<div class="multimedia-content">
            <span class="media-icon">${fileIcon}</span>
            <p><strong>æª”æ¡ˆ: ${fileName}</strong></p>
            <a href="${fileUrl}" target="_blank">ä¸‹è¼‰æª”æ¡ˆ</a>
        </div>`;
    });
    
    // Process audio files
    html = html.replace(/\[audio:([^\]]+)\]\(([^)]+)\)/g, (match, audioName, audioUrl) => {
        return `<div class="multimedia-content">
            <span class="media-icon">ğŸµ</span>
            <p><strong>éŸ³é »: ${audioName}</strong></p>
            <a href="${audioUrl}" target="_blank">æ’­æ”¾éŸ³é »</a>
        </div>`;
    });
    
    return html;
}

// Escape HTML
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// Show Notification
function showNotification(message, duration = 2000) {
    if (!copyNotification) return;
    
    const messageSpan = copyNotification.querySelector('.notification-text');
    if (messageSpan) {
        messageSpan.textContent = message;
    } else {
        // If notification structure is different, update it directly
        copyNotification.innerHTML = `
            <span class="notification-icon">âœ…</span>
            <span class="notification-text">${message}</span>
        `;
    }
    
    // Make sure notification is visible
    copyNotification.classList.remove('hidden');
    copyNotification.style.opacity = '1';
    copyNotification.style.transform = 'translateX(0)';
    
    // Hide after duration
    setTimeout(() => {
        copyNotification.classList.add('hidden');
        copyNotification.style.opacity = '0';
        copyNotification.style.transform = 'translateX(100%)';
    }, duration);
}

// Create Floating Particles
function createFloatingParticles() {
    const particlesContainer = document.querySelector('.floating-particles');
    if (!particlesContainer) return;
    
    // Create additional particles dynamically
    for (let i = 0; i < 8; i++) {
        const particle = document.createElement('div');
        particle.style.cssText = `
            position: absolute;
            width: ${2 + Math.random() * 4}px;
            height: ${2 + Math.random() * 4}px;
            background: var(--cyber-primary);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--cyber-glow);
            animation: float ${4 + Math.random() * 4}s ease-in-out infinite;
            animation-delay: ${-Math.random() * 8}s;
            top: ${Math.random() * 100}%;
            left: ${Math.random() * 100}%;
            opacity: ${0.2 + Math.random() * 0.6};
        `;
        particlesContainer.appendChild(particle);
    }
}

// Add smooth transitions between categories
function addTransitionEffects() {
    const style = document.createElement('style');
    style.id = 'transition-effects';
    style.textContent = `
        .category-content {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s ease-out;
        }
        
        .category-content.active {
            opacity: 1;
            transform: translateY(0);
        }
        
        .note-card {
            transform: translateY(10px);
            opacity: 0;
            animation: slideInUp 0.3s ease-out forwards;
        }
        
        @keyframes slideInUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes ripple {
            to {
                transform: scale(2);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
}

// Add visual feedback for interactions
document.addEventListener('click', (e) => {
    if (e.target.closest('.tab-button, .action-btn, .add-note-btn')) {
        // Create ripple effect
        const button = e.target.closest('.tab-button, .action-btn, .add-note-btn');
        const ripple = document.createElement('div');
        
        const rect = button.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;
        
        ripple.style.cssText = `
            position: absolute;
            width: ${size}px;
            height: ${size}px;
            left: ${x}px;
            top: ${y}px;
            background: var(--cyber-glow);
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 0.6s ease-out;
            pointer-events: none;
            z-index: 1;
        `;
        
        button.style.position = 'relative';
        button.style.overflow = 'hidden';
        button.appendChild(ripple);
        
        setTimeout(() => {
            ripple.remove();
        }, 600);
    }
});

// Easter egg: Konami code
let konamiCode = [];
const konamiSequence = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'KeyB', 'KeyA'];

document.addEventListener('keydown', (e) => {
    konamiCode.push(e.code);
    if (konamiCode.length > konamiSequence.length) {
        konamiCode.shift();
    }
    
    if (JSON.stringify(konamiCode) === JSON.stringify(konamiSequence)) {
        showNotification('ğŸ® Konami Code activated! åŠ æ²¹æº«æ›¸ï¼DSEå¿…å‹ï¼', 4000);
        document.body.style.animation = 'cyberGlow 0.5s ease-in-out 3';
        konamiCode = [];
        
        // Add special effects
        const specialEffect = document.createElement('div');
        specialEffect.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, 
                rgba(0,255,255,0.1) 0%, 
                rgba(0,102,255,0.1) 50%, 
                rgba(102,204,255,0.1) 100%);
            animation: specialGlow 2s ease-in-out;
            pointer-events: none;
            z-index: 9999;
        `;
        
        if (!document.getElementById('special-style')) {
            const specialStyle = document.createElement('style');
            specialStyle.id = 'special-style';
            specialStyle.textContent = `
                @keyframes specialGlow {
                    0%, 100% { opacity: 0; }
                    50% { opacity: 1; }
                }
            `;
            document.head.appendChild(specialStyle);
        }
        
        document.body.appendChild(specialEffect);
        
        setTimeout(() => {
            specialEffect.remove();
        }, 2000);
    }
});
