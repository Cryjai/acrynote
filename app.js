// Application Data with enhanced structure
const notesData = {
  "categories": {
    "中文": [
      {
        "id": "chinese_1",
        "title": "文言文秘笈",
        "content": "# 文言文終極攻略\n\n之乎者也終極攻略，包括常用虛詞、實詞解析。重點掌握：\n\n![古代書法示例](https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=500&h=300&fit=crop)\n\n## 虛詞詳解\n\n### 常用虛詞分類\n- **之**：助詞、代詞、動詞\n  - 助詞：的、地\n  - 代詞：他、它、這\n  - 動詞：到、往\n\n- **乎**：語氣詞、介詞\n  - 語氣詞：呢、嗎\n  - 介詞：於、在\n\n- **者**：代詞、助詞\n  - 代詞：...的人、...的事物\n  - 助詞：用於定語後\n\n- **也**：語氣詞、判斷詞\n  - 語氣詞：啊、呢\n  - 判斷詞：是\n\n[youtube:dQw4w9WgXcQ]\n\n## 實詞重點\n\n### 通假字規律\n通假字是古代用字習慣，需要掌握常見模式：\n- 音近通假：如「蚤」通「早」\n- 義近通假：如「亡」通「無」\n\n### 古今異義詞\n詞義在歷史中發生變化的詞語：\n- **妻子**：古義指妻子和兒女，今義指配偶\n- **學者**：古義指求學的人，今義指有學問的人\n\n[file:文言文虛詞表.pdf](https://example.com/wenyanwen.pdf)\n\n## 句式分析\n\n### 判斷句\n- 格式：...者...也\n- 例句：廉頗者，趙之良將也\n\n### 被動句\n- 格式：見...於、為...所\n- 例句：吾長見笑於大方之家",
        "tags": ["文言文", "虛詞", "DSE中文"]
      },
      {
        "id": "chinese_2",
        "title": "作文神技",
        "content": "# 作文終極技巧\n\n議論文三段論 + 記敘文情感渲染技巧\n\n![寫作技巧圖解](https://images.unsplash.com/photo-1455390582262-044cdead277a?w=500&h=300&fit=crop)\n\n## 議論文結構\n\n### 引論技巧\n- **開門見山法**：直接提出論點\n- **引用名言法**：借名人之口增強說服力\n- **設問法**：引發讀者思考\n- **對比法**：通過對比突出論點\n\n### 本論展開\n本論是文章的核心部分，需要：\n\n#### 論證方法\n- **舉例論證**：用具體事例證明論點\n- **引用論證**：引用權威言論或數據\n- **對比論證**：通過正反對比說明道理\n- **比喻論證**：用生動比喻説明抽象道理\n\n#### 論證結構\n每個分論點都應該包含：\n1. 提出分論點\n2. 分析論證\n3. 舉例說明\n4. 總結回扣\n\n[audio:作文朗讀示範.mp3](https://example.com/zuowen_demo.mp3)\n\n## 記敘文技巧\n\n### 情感渲染\n記敘文的生命力在於情感的真摯表達：\n\n#### 細節描寫\n- **外貌描寫**：抓住特徵，突出性格\n- **動作描寫**：展現人物內心世界\n- **語言描寫**：個性化對話，推進情節\n- **心理描寫**：直接揭示內心活動\n\n#### 環境渲染\n- **自然環境**：烘托氣氛，暗示情感\n- **社會環境**：交代背景，推動情節\n\n### 結構安排\n- **首尾呼應**：前後照應，結構完整\n- **欲揚先抑**：先抑後揚，增強效果\n- **插敘倒敘**：豐富內容，增加懸念",
        "tags": ["作文", "議論文", "記敘文"]
      }
    ],
    "英文": [
      {
        "id": "english_1",
        "title": "Grammar Mastery",
        "content": "# Grammar Ultimate Guide\n\n**Present Perfect vs Past Simple 終極指南：**\n\n[youtube:1Dax90QyXgI]\n\n## Present Perfect Tense\n\n### 基本概念\nPresent Perfect用於描述過去發生但與現在相關的動作或狀態。\n\n#### 構成方式\n- **公式**: have/has + past participle\n- **例句**: \n  - I have finished my homework.\n  - She has lived here for 5 years.\n\n#### 使用情況\n1. **未完成的動作**：從過去開始，持續到現在\n   - I have studied English for 10 years.\n\n2. **剛完成的動作**：剛剛完成，對現在有影響\n   - I have just eaten lunch.\n\n3. **人生經歷**：到目前為止的經歷\n   - I have been to Japan twice.\n\n![Grammar Timeline](https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=500&h=300&fit=crop)\n\n## Past Simple Tense\n\n### 基本概念\nPast Simple用於描述過去特定時間完成的動作。\n\n#### 構成方式\n- **規則動詞**: 動詞 + ed\n- **不規則動詞**: 需要記憶特殊形式\n\n#### 關鍵時間詞\n- yesterday, last week, in 2020, ago, when I was young\n\n### 時態對比\n\n#### Present Perfect標誌詞\n- already, just, yet, since, for, ever, never\n\n#### Past Simple標誌詞\n- yesterday, last week, ago, in 1990, when\n\n[file:Grammar_Reference_Sheet.pdf](https://example.com/grammar.pdf)\n\n## 記憶技巧\n\n### 口訣記憶\n- **Present Perfect** = 過去+現在連結\n- **Past Simple** = 純粹過去事件\n\n### 練習建議\n1. 每日造句練習\n2. 閱讀英文文章，注意時態使用\n3. 與native speaker對話練習",
        "tags": ["grammar", "tenses", "DSE English"]
      },
      {
        "id": "english_2",
        "title": "Essay Writing Formula",
        "content": "# Essay Writing Mastery\n\n**完美Essay結構公式：**\n\n[youtube:8Ph06d2gI0Y]\n\n## Introduction Structure\n\n### Hook Techniques\n開場白是吸引讀者的關鍵：\n\n#### 常用Hook類型\n- **引用名言**: \"Education is the most powerful weapon which you can use to change the world.\" - Nelson Mandela\n- **驚人統計**: Did you know that 95% of students struggle with essay writing?\n- **設問句**: What if I told you that writing a perfect essay is easier than you think?\n- **生動場景**: Picture this: a student staring at a blank page, paralyzed by the fear of writing.\n\n![Essay Structure Diagram](https://images.unsplash.com/photo-1456324504439-367cee3b3c32?w=500&h=300&fit=crop)\n\n### Background Information\n提供必要的背景資訊，幫助讀者理解topic context。\n\n### Thesis Statement\n論文陳述是essay的核心，必須：\n- 明確表達主要論點\n- 預告文章結構\n- 具有爭議性和討論價值\n\n## Body Paragraph Structure\n\n### PEEL Method\n每個Body Paragraph都應該遵循PEEL結構：\n\n#### Point (論點)\n- 清晰提出分論點\n- 與thesis statement呼應\n\n#### Evidence (證據)\n- 提供具體examples, statistics, quotes\n- 確保證據的可靠性和相關性\n\n#### Explanation (解釋)\n- 分析證據如何支持論點\n- 深入探討因果關係\n\n#### Link (連結)\n- 總結段落要點\n- 過渡到下一段落\n\n### Transition Words\n有效的過渡詞讓文章流暢：\n\n#### 因果關係\n- Therefore, consequently, as a result, hence\n\n#### 對比關係\n- However, nevertheless, on the contrary, whereas\n\n#### 補充關係\n- Furthermore, moreover, additionally, in addition\n\n## Conclusion Strategies\n\n### 結論三要素\n1. **重申Thesis**: 用不同措辭重申主要論點\n2. **總結要點**: 簡潔概括主要論證\n3. **Call to Action**: 提出建議或呼籲行動\n\n### 結論技巧\n- 回到Hook呼應開頭\n- 提出更廣泛的implications\n- 以強有力的statement結尾\n\n[file:Essay_Templates.pdf](https://example.com/essay_templates.pdf)",
        "tags": ["essay", "writing", "structure"]
      }
    ],
    "Econ": [
      {
        "id": "econ_1",
        "title": "Supply & Demand Analysis",
        "content": "# Market Mechanisms\n\n**Market equilibrium analysis and price mechanisms:**\n\n![Supply and Demand Graph](https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=500&h=300&fit=crop)\n\n## Supply Analysis\n\n### Supply Curve Characteristics\nSupply curve shows the relationship between price and quantity supplied:\n\n#### Law of Supply\n- **基本定律**: Price ↑ → Quantity Supplied ↑\n- **原理**: Higher prices provide greater incentive to produce\n- **例外**: Backward-bending supply curve for labour\n\n#### Supply Determinants\nFactors that shift the entire supply curve:\n\n##### Production Costs\n- Raw material prices\n- Labour costs\n- Technology improvements\n- Government subsidies/taxes\n\n##### Market Conditions\n- Number of sellers\n- Future price expectations\n- Seasonal factors\n\n[youtube:3ez10ADR_gM]\n\n## Demand Analysis\n\n### Demand Curve Properties\nDemand curve illustrates consumer behavior:\n\n#### Law of Demand\n- **基本定律**: Price ↑ → Quantity Demanded ↓\n- **Income Effect**: Higher prices reduce purchasing power\n- **Substitution Effect**: Consumers switch to alternatives\n\n#### Demand Shifters\nNon-price factors affecting demand:\n\n##### Consumer Factors\n- Income levels (normal vs inferior goods)\n- Consumer preferences and trends\n- Population demographics\n- Future expectations\n\n##### Market Factors\n- Prices of substitutes and complements\n- Seasonal variations\n- Marketing and advertising effects\n\n## Market Equilibrium\n\n### Equilibrium Concept\nWhere supply meets demand (S = D):\n\n#### Price Mechanism\n- **Market-clearing price**: No shortage or surplus\n- **Automatic adjustment**: Prices adjust to balance supply and demand\n- **Efficiency**: Resources allocated optimally\n\n#### Disequilibrium Analysis\n- **Shortage**: Demand > Supply → Price ↑\n- **Surplus**: Supply > Demand → Price ↓\n- **Market forces**: Automatic tendency toward equilibrium\n\n[file:Supply_Demand_Charts.pdf](https://example.com/supply_demand.pdf)\n\n### Consumer and Producer Surplus\n\n#### Consumer Surplus\n- Area below demand curve, above price\n- Represents consumer benefit\n- Welfare measure of consumer well-being\n\n#### Producer Surplus\n- Area above supply curve, below price\n- Represents producer profit\n- Measure of producer welfare\n\n#### Total Welfare\n- Sum of consumer and producer surplus\n- Maximized at market equilibrium\n- Deadweight loss from market inefficiency",
        "tags": ["microeconomics", "market", "DSE Econ"]
      },
      {
        "id": "econ_2",
        "title": "GDP and Economic Growth",
        "content": "# National Income Accounting\n\n**Nominal vs Real GDP, inflation adjustments:**\n\n![Economic Data Visualization](https://images.unsplash.com/photo-1590283603385-17ffb3a7f29f?w=500&h=300&fit=crop)\n\n## GDP Measurement\n\n### GDP Definition\nGross Domestic Product measures total economic output:\n\n#### Three Approaches\n1. **Production Approach**: Sum of value added\n2. **Income Approach**: Sum of factor incomes\n3. **Expenditure Approach**: C + I + G + (X-M)\n\n### Nominal vs Real GDP\n\n#### Nominal GDP\n- **定義**: Current market prices\n- **計算**: Σ(Price × Quantity) for current year\n- **問題**: Affected by inflation\n- **用途**: Comparing different economies at same time\n\n#### Real GDP\n- **定義**: Constant prices (inflation-adjusted)\n- **計算**: Using base year prices\n- **優點**: Shows actual economic growth\n- **用途**: Comparing same economy over time\n\n### GDP Deflator\n\n#### Calculation\n**GDP Deflator = (Nominal GDP / Real GDP) × 100**\n\n#### Interpretation\n- Measures overall price level changes\n- Broader than CPI (includes all goods/services)\n- Shows economy-wide inflation rate\n\n[file:GDP_Calculation_Worksheet.pdf](https://example.com/gdp_calc.pdf)\n\n## Economic Growth Analysis\n\n### Growth Rate Calculation\n\n#### Formula\n**Growth Rate = [(Real GDP₂ - Real GDP₁) / Real GDP₁] × 100%**\n\n#### Per Capita Growth\n- Accounts for population changes\n- Better measure of living standards\n- Formula: GDP per capita = Total GDP / Population\n\n### Factors Affecting Growth\n\n#### Supply-Side Factors\n- Labour force quantity and quality\n- Capital stock and investment\n- Technological progress\n- Natural resources\n\n#### Demand-Side Factors\n- Consumption spending\n- Investment demand\n- Government expenditure\n- Net exports\n\n## Business Cycle Analysis\n\n### Cycle Phases\n\n#### Expansion\n- GDP growth above trend\n- Falling unemployment\n- Rising consumer confidence\n- Increasing investment\n\n#### Peak\n- Maximum GDP level\n- Full employment\n- Potential inflation pressure\n- Economic overheating risk\n\n#### Contraction/Recession\n- Negative GDP growth\n- Rising unemployment\n- Falling business confidence\n- Decreased investment\n\n#### Trough\n- Lowest GDP point\n- High unemployment\n- Economic recovery preparation\n- Policy intervention timing\n\n### Economic Indicators\n\n#### Leading Indicators\n- Stock market performance\n- Consumer confidence\n- New business formation\n- Employment trends\n\n#### Lagging Indicators\n- Unemployment rate\n- Corporate profits\n- Consumer debt levels\n- Interest rate changes",
        "tags": ["macroeconomics", "GDP", "inflation"]
      }
    ],
    "中史": [
      {
        "id": "history_1",
        "title": "唐朝盛世研究",
        "content": "# 唐朝政治經濟文化\n\n**貞觀之治、開元盛世政治經濟文化特色：**\n\n![唐朝地圖](https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=500&h=300&fit=crop)\n\n## 政治制度\n\n### 中央政府結構\n\n#### 三省六部制\n唐朝完善了隋朝的三省六部制：\n\n##### 三省職能\n- **中書省**：起草詔書，決策機構\n- **門下省**：審核詔書，監督機構\n- **尚書省**：執行詔書，行政機構\n\n##### 六部分工\n- **吏部**：人事任免\n- **戶部**：財政收支\n- **禮部**：教育科舉\n- **兵部**：軍事管理\n- **刑部**：司法審判\n- **工部**：工程營造\n\n#### 科舉制度\n\n##### 考試科目\n- **明經科**：考試經典知識\n- **進士科**：考試詩賦文章\n- **制舉科**：皇帝特設考試\n\n##### 制度意義\n- 打破門第觀念\n- 選拔人才機制\n- 加強中央集權\n- 促進社會流動\n\n[audio:唐詩朗誦示範.mp3](https://example.com/tangshi.mp3)\n\n## 經濟發展\n\n### 農業繁榮\n\n#### 土地制度\n- **均田制**：分配土地給農民\n- **租庸調制**：賦稅徵收制度\n- **府兵制**：軍事與農業結合\n\n#### 農業技術\n- 犁具改進（曲轅犁）\n- 水利工程建設\n- 作物品種改良\n- 農時安排優化\n\n### 商業繁榮\n\n#### 絲綢之路\n- **陸上絲綢之路**：連接亞歐大陸\n- **海上絲綢之路**：通往東南亞\n- **商品貿易**：絲綢、茶葉、瓷器\n- **文化交流**：宗教、藝術、技術\n\n#### 貨幣制度\n- 統一貨幣標準\n- 開元通寶流通\n- 信用制度發展\n- 商業信貸出現\n\n## 文化成就\n\n### 詩歌鼎盛\n\n#### 代表詩人\n- **李白**：浪漫主義代表\n  - 代表作：《將進酒》、《蜀道難》\n  - 風格：豪放不羈，想像豐富\n\n- **杜甫**：現實主義代表\n  - 代表作：《三吏》、《三別》\n  - 風格：憂國憂民，沉鬱頓挫\n\n- **白居易**：新樂府運動\n  - 代表作：《長恨歌》、《琵琶行》\n  - 風格：通俗易懂，關注民生\n\n#### 詩歌特色\n- 題材廣泛多樣\n- 藝術技巧成熟\n- 思想內容豐富\n- 影響後世深遠\n\n### 宗教文化\n\n#### 佛教興盛\n- 寺院經濟發達\n- 佛教藝術繁榮\n- 玄奘西行取經\n- 佛教中國化進程\n\n#### 道教發展\n- 皇室扶持道教\n- 道教理論完善\n- 煉丹術發展\n- 養生文化興起\n\n[file:唐朝年表.pdf](https://example.com/tang_timeline.pdf)\n\n### 對外開放\n\n#### 外交政策\n- 冊封制度完善\n- 和親政策實施\n- 朝貢體系建立\n- 文化交流頻繁\n\n#### 國際地位\n- 亞洲政治中心\n- 經濟文化強國\n- 外國使節雲集\n- 留學生紛至沓來",
        "tags": ["唐朝", "政治", "經濟"]
      },
      {
        "id": "history_2",
        "title": "明清政治變遷",
        "content": "# 明清制度演變\n\n**明末清初政治制度變化與影響：**\n\n![明清宮殿建築](https://images.unsplash.com/photo-1548013146-72479768bada?w=500&h=300&fit=crop)\n\n## 明朝政治制度\n\n### 中央集權加強\n\n#### 廢除丞相制\n朱元璋廢除丞相制度的影響：\n\n##### 制度變化\n- **1380年**：胡惟庸案後廢除中書省\n- **權力集中**：皇帝直接管理六部\n- **內閣出現**：協助皇帝處理政務\n- **票擬制度**：內閣提出處理意見\n\n##### 內閣制度發展\n- **洪武後期**：設立文淵閣\n- **永樂時期**：內閣制度化\n- **成化以後**：首輔制度確立\n- **明末期間**：內閣黨爭激烈\n\n#### 廠衞制度\n\n##### 特務機構\n- **錦衣衞**：皇帝親軍，負責偵緝\n- **東廠**：宦官主管，監視百官\n- **西廠**：短期設立，權力極大\n- **內行廠**：明末設立，後被廢除\n\n##### 制度影響\n- 加強皇權統治\n- 監視官員百姓\n- 造成恐怖政治\n- 影響政治清明\n\n[youtube:kJQP7kiw5Fk]\n\n### 地方行政\n\n#### 三司分權\n- **承宣布政使司**：民政管理\n- **提刑按察使司**：司法監察\n- **都指揮使司**：軍事管理\n\n#### 分權目的\n- 防止地方割據\n- 加強中央控制\n- 相互制衡監督\n- 提高行政效率\n\n## 清朝政治制度\n\n### 滿漢並用政策\n\n#### 制度設計\n清朝在政治制度上採取滿漢並用：\n\n##### 中央政府\n- **議政王大臣會議**：清初最高決策機構\n- **內三院**：效仿明朝內閣制度\n- **六部制**：承襲明朝行政體系\n- **理藩院**：專管蒙古、西藏事務\n\n##### 軍機處設立\n- **雍正時期**：設立軍機處\n- **職能**：協助皇帝處理軍國大事\n- **特點**：效率高、保密性強\n- **影響**：進一步強化皇權\n\n### 八旗制度\n\n#### 組織結構\n- **滿洲八旗**：滿族核心力量\n- **蒙古八旗**：聯盟蒙古部族\n- **漢軍八旗**：歸降漢人軍隊\n\n#### 社會功能\n- 軍事組織基礎\n- 社會管理單位\n- 經濟供養體系\n- 身分等級標識\n\n### 科舉制度改革\n\n#### 制度調整\n- 保留科舉考試\n- 增加滿文考試\n- 設立翻譯科目\n- 限制漢人名額\n\n#### 文字政策\n- 推行滿文教育\n- 官方文書雙語\n- 保護滿族文化\n- 防範漢化影響\n\n[file:明清政治制度對比表.pdf](https://example.com/mingqing_compare.pdf)\n\n## 政治制度影響\n\n### 中央集權強化\n\n#### 積極影響\n- 國家統一穩定\n- 政令統一有效\n- 經濟發展促進\n- 文化交流頻繁\n\n#### 消極影響\n- 專制程度加深\n- 官僚腐敗嚴重\n- 社會活力減弱\n- 創新能力下降\n\n### 滿漢關係\n\n#### 政治安排\n- 滿漢官員並用\n- 關鍵職位滿人\n- 制衡政策實施\n- 文化融合促進\n\n#### 社會矛盾\n- 民族矛盾存在\n- 等級制度森嚴\n- 反清勢力持續\n- 文化衝突時現\n\n### 現代化進程\n\n#### 制度僵化\n- 政治體制保守\n- 改革阻力巨大\n- 西方衝擊劇烈\n- 近代化滯後\n\n#### 變革需求\n- 政治民主化\n- 經濟現代化\n- 文化開放性\n- 社會平等性",
        "tags": ["明清", "政治制度", "變遷"]
      }
    ]
  }
};

// Tag type mapping for colors
const tagTypes = {
  // Subject tags - Cyan
  '文言文': 'cyan',
  'grammar': 'cyan',
  'microeconomics': 'cyan',
  'macroeconomics': 'cyan',
  '唐朝': 'cyan',
  '明清': 'cyan',
  
  // Skill tags - Purple  
  '虛詞': 'purple',
  '作文': 'purple',
  '議論文': 'purple',
  '記敘文': 'purple',
  'phrases': 'purple',
  'vocab': 'purple',
  'tenses': 'purple',
  'essay': 'purple',
  'writing': 'purple',
  'structure': 'purple',
  'market': 'purple',
  'GDP': 'purple',
  'inflation': 'purple',
  '政治': 'purple',
  '經濟': 'purple',
  '政治制度': 'purple',
  '變遷': 'purple',
  
  // Exam tags - Orange
  'DSE中文': 'orange',
  'DSE English': 'orange',
  'DSE Econ': 'orange'
};

// Application State
let currentCategory = '中文';
let allNotes = {};
let filteredNotes = {};
let headerCollapseStates = new Map(); // Track collapse state of headers

// DOM Elements - Initialize after DOM is loaded
let tabButtons, categoryContents, searchInput, copyNotification, addNoteBtn;

// Initialize Application
document.addEventListener('DOMContentLoaded', function() {
    // Initialize DOM elements
    tabButtons = document.querySelectorAll('.tab-button');
    categoryContents = document.querySelectorAll('.category-content');
    searchInput = document.getElementById('searchInput');
    copyNotification = document.getElementById('copyNotification');
    addNoteBtn = document.getElementById('addNoteBtn');
    
    // Load notes data
    loadNotesData();
    
    // Render initial category
    renderCategory(currentCategory);
    
    // Setup event listeners
    setupEventListeners();
    
    // Add floating particles
    createFloatingParticles();
    
    // Add transition effects
    addTransitionEffects();
});

// Load and organize notes data
function loadNotesData() {
    allNotes = notesData.categories;
    filteredNotes = JSON.parse(JSON.stringify(allNotes)); // Deep copy
}

// Setup Event Listeners
function setupEventListeners() {
    // Tab switching
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const category = button.dataset.category;
            switchCategory(category);
        });
    });

    // Search functionality with debouncing
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = e.target.value.toLowerCase().trim();
                filterNotes(query);
            }, 200);
        });
    }

    // Add note button
    if (addNoteBtn) {
        addNoteBtn.addEventListener('click', () => {
            showNotification('功能開發中... 請直接修改 app.js 添加新筆記！', 3000);
        });
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + F to focus search
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            if (searchInput) searchInput.focus();
        }
        
        // ESC to clear search
        if (e.key === 'Escape' && searchInput && searchInput === document.activeElement) {
            searchInput.value = '';
            filterNotes('');
        }
    });
}

function parseContent(content) {
    let parsed = content;
    // 圖片 inline
    parsed = parsed.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,
        '<div class="image-container"><img src="$2" alt="$1" class="note-image" loading="lazy"></div>');
    // YouTube inline
    parsed = parsed.replace(/\[youtube:([^\]]+)\]/g,
        '<div class="youtube-container"><iframe src="https://www.youtube.com/embed/$1" frameborder="0" allowfullscreen class="youtube-video"></iframe></div>');
    // PDF inline
    parsed = parsed.replace(/\[file:([^\]]*)\]\(([^)]+)\)/g,
        '<div class="file-container"><embed src="$2" type="application/pdf" class="pdf-viewer"><p>PDF: <a href="$2" target="_blank">$1</a></p></div>');
    // Audio inline
    parsed = parsed.replace(/\[audio:([^\]]*)\]\(([^)]+)\)/g,
        '<div class="audio-container"><audio controls class="audio-player"><source src="$2" type="audio/mpeg">Your browser does not support audio.</audio><p>🎵 $1</p></div>');
    // Markdown
    parsed = parsed.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    parsed = parsed.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    parsed = parsed.replace(/\n/g, '<br>');
    return parsed;
}


// Switch Category
function switchCategory(category) {
    if (category === currentCategory) return;

    // Update tab buttons
    tabButtons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.category === category) {
            btn.classList.add('active');
        }
    });

    // Update content visibility with smooth transition
    categoryContents.forEach(content => {
        content.classList.remove('active');
        if (content.dataset.category === category) {
            // Small delay for smooth transition
            setTimeout(() => {
                content.classList.add('active');
            }, 100);
        }
    });

    currentCategory = category;
    
    // Clear search
    if (searchInput) {
        searchInput.value = '';
    }
    filterNotes('');
    
    // Render new category
    renderCategory(category);
}

// Render Category Notes
function renderCategory(category) {
    const container = document.getElementById(`notes-${category}`);
    const notes = filteredNotes[category] || [];
    
    if (!container) return;
    
    container.innerHTML = '';
    
    if (notes.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">🔍</div>
                <p style="font-size: 1.1rem;">沒有找到相關筆記</p>
                <p style="font-size: 0.9rem; margin-top: 0.5rem;">試試其他關鍵字或切換分類</p>
            </div>
        `;
        return;
    }
    
    notes.forEach((note, index) => {
        const noteCard = createNoteCard(note);
        noteCard.style.animationDelay = `${index * 0.1}s`;
        container.appendChild(noteCard);
    });
}

// Create Note Card
function createNoteCard(note) {
    const card = document.createElement('div');
    card.className = 'note-card';
    card.dataset.noteId = note.id;
    
    const formattedContent = formatMarkdownWithCollapse(note.content, note.id);
    const tagsHtml = createTagsHtml(note.tags);
    
    card.innerHTML = `
        <div class="note-header">
            <h3 class="note-title">${escapeHtml(note.title)}</h3>
            <div class="note-actions">
                <button class="action-btn copy-btn" title="複製內容">
                    📋
                </button>
                <button class="action-btn expand-btn" title="展開/收起">
                    <span class="expand-icon">🔽</span>
                </button>
            </div>
        </div>
        <div class="note-content">
            <div class="note-text">${formattedContent}</div>
            <div class="note-tags">${tagsHtml}</div>
        </div>
    `;
    
    // Add event listeners to the card
    const noteHeader = card.querySelector('.note-header');
    const copyBtn = card.querySelector('.copy-btn');
    const expandBtn = card.querySelector('.expand-btn');
    
    // Note expansion toggle
    noteHeader.addEventListener('click', (e) => {
        // Don't trigger expansion if clicking on action buttons
        if (!e.target.closest('.action-btn')) {
            toggleNoteExpansion(note.id);
        }
    });
    
    // Copy functionality with attribution
    copyBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        copyNoteContentWithAttribution(note.id, e);
    });
    
    // Expand button
    expandBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleNoteExpansion(note.id);
    });
    
    // Setup collapsible headers after card is created
    setTimeout(() => setupCollapsibleHeaders(card, note.id), 100);
    
    return card;
}

// Setup Collapsible Headers
function setupCollapsibleHeaders(card, noteId) {
    const headers = card.querySelectorAll('h1, h2, h3, .header-h1, .header-h2, .header-h3');
    
    headers.forEach((header, index) => {
        const headerLevel = getHeaderLevel(header);
        const headerId = `${noteId}-header-${index}`;
        const collapseKey = headerId;
        
        // Skip if already processed
        if (header.classList.contains('collapsible-header')) return;
        
        // Add collapsible class and structure
        header.classList.add('collapsible-header');
        header.dataset.headerId = headerId;
        
        // Create collapse icon
        const collapseIcon = document.createElement('span');
        collapseIcon.className = 'collapse-icon';
        collapseIcon.innerHTML = '▼';
        collapseIcon.title = '點擊收起/展開';
        
        // Insert collapse icon at the beginning
        header.insertBefore(collapseIcon, header.firstChild);
        
        // Find content to collapse (everything until next header of same or higher level)
        const contentToCollapse = getHeaderContent(header, headerLevel);
        
        if (contentToCollapse.length > 0) {
            // Wrap content in collapsible container
            const collapseContainer = document.createElement('div');
            collapseContainer.className = 'collapsible-content';
            collapseContainer.dataset.headerId = headerId;
            
            // Move content into container
            contentToCollapse.forEach(element => {
                collapseContainer.appendChild(element);
            });
            
            // Insert container after header
            header.parentNode.insertBefore(collapseContainer, header.nextSibling);
            
            // Add click event to header
            header.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                toggleHeaderCollapse(headerId);
            });
            
            // Restore collapse state if exists
            const isCollapsed = headerCollapseStates.get(collapseKey);
            if (isCollapsed) {
                header.classList.add('collapsed');
                collapseContainer.classList.add('collapsed');
                collapseIcon.innerHTML = '▶';
            }
        }
    });
}

// Get Header Level
function getHeaderLevel(header) {
    const tagName = header.tagName.toLowerCase();
    if (tagName === 'h1' || header.classList.contains('header-h1')) return 1;
    if (tagName === 'h2' || header.classList.contains('header-h2')) return 2;
    if (tagName === 'h3' || header.classList.contains('header-h3')) return 3;
    return 1;
}

// Get Header Content
function getHeaderContent(header, headerLevel) {
    const contentElements = [];
    let nextElement = header.nextElementSibling;
    
    while (nextElement) {
        const nextLevel = getHeaderLevel(nextElement);
        const isHeader = nextElement.tagName.match(/^H[1-3]$/i) || 
                        nextElement.classList.contains('header-h1') ||
                        nextElement.classList.contains('header-h2') ||
                        nextElement.classList.contains('header-h3');
        
        // Stop if we hit a header of same or higher level
        if (isHeader && nextLevel <= headerLevel) {
            break;
        }
        
        // Skip if it's already a collapsible-content container
        if (nextElement.classList.contains('collapsible-content')) {
            nextElement = nextElement.nextElementSibling;
            continue;
        }
        
        contentElements.push(nextElement);
        const current = nextElement;
        nextElement = nextElement.nextElementSibling;
        
        // Remove from DOM temporarily
        current.remove();
    }
    
    return contentElements;
}

// Toggle Header Collapse
function toggleHeaderCollapse(headerId) {
    const header = document.querySelector(`[data-header-id="${headerId}"]`);
    const content = document.querySelector(`.collapsible-content[data-header-id="${headerId}"]`);
    const icon = header?.querySelector('.collapse-icon');
    
    if (!header || !content) return;
    
    const isCurrentlyCollapsed = header.classList.contains('collapsed');
    
    if (isCurrentlyCollapsed) {
        // Expand
        header.classList.remove('collapsed');
        content.classList.remove('collapsed');
        if (icon) icon.innerHTML = '▼';
        headerCollapseStates.delete(headerId);
    } else {
        // Collapse
        header.classList.add('collapsed');
        content.classList.add('collapsed');
        if (icon) icon.innerHTML = '▶';
        headerCollapseStates.set(headerId, true);
    }
}

// Create Tags HTML
function createTagsHtml(tags) {
    return tags.map(tag => {
        const tagType = tagTypes[tag] || 'cyan';
        return `<span class="tag tag--${tagType}" data-tag="${escapeHtml(tag)}">${escapeHtml(tag)}</span>`;
    }).join('');
}

// Filter by tag (add event listeners after rendering)
function attachTagListeners() {
    document.querySelectorAll('.tag').forEach(tag => {
        tag.addEventListener('click', (e) => {
            e.stopPropagation();
            const tagText = e.target.dataset.tag;
            filterByTag(tagText);
        });
    });
}

// Filter by tag
function filterByTag(tag) {
    if (searchInput) {
        searchInput.value = tag;
    }
    filterNotes(tag.toLowerCase());
    showNotification(`正在搜尋標籤：${tag}`, 1500);
}

// Toggle Note Expansion
function toggleNoteExpansion(noteId) {
    const card = document.querySelector(`[data-note-id="${noteId}"]`);
    if (!card) return;
    
    const isExpanded = card.classList.contains('expanded');
    card.classList.toggle('expanded');
    
    // Update expand icon
    const expandIcon = card.querySelector('.expand-icon');
    if (expandIcon) {
        expandIcon.textContent = isExpanded ? '🔽' : '🔼';
    }
    
    // Smooth scroll to card if expanding
    if (!isExpanded) {
        setTimeout(() => {
            card.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest' 
            });
        }, 200);
    }
}

// Copy Note Content with Acry CEO Attribution
async function copyNoteContentWithAttribution(noteId, event) {
    // Find the note content
    const note = findNoteById(noteId);
    if (!note) return;
    
    // Add attribution to content
    const attribution = "\n\n---\nPowered by Acry CEO, GitHub https://github.com/Cryjai";
    const contentWithAttribution = note.content + attribution;
    
    try {
        await navigator.clipboard.writeText(contentWithAttribution);
        
        // Show success notification with attribution message
        showNotification('已複製到剪貼板 (含Acry CEO署名)', 2500);
        
        // Visual feedback on button
        const button = event.currentTarget;
        const originalIcon = button.textContent;
        const originalColor = button.style.color;
        
        button.textContent = '✅';
        button.style.color = 'var(--cyber-primary)';
        button.style.transform = 'scale(1.2)';
        
        setTimeout(() => {
            button.textContent = originalIcon;
            button.style.color = originalColor;
            button.style.transform = '';
        }, 1500);
        
    } catch (err) {
        console.error('Failed to copy text: ', err);
        
        // Fallback: try to select text using older method
        try {
            const textArea = document.createElement('textarea');
            textArea.value = contentWithAttribution;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);
            
            if (successful) {
                showNotification('已複製到剪貼板 (含Acry CEO署名)', 2500);
                
                // Visual feedback on button
                const button = event.currentTarget;
                const originalIcon = button.textContent;
                button.textContent = '✅';
                button.style.color = 'var(--cyber-primary)';
                
                setTimeout(() => {
                    button.textContent = originalIcon;
                    button.style.color = '';
                }, 1500);
            } else {
                throw new Error('execCommand failed');
            }
        } catch (fallbackErr) {
            showNotification('複製失敗，請手動選擇文字複製', 3000);
            console.error('Fallback copy failed: ', fallbackErr);
        }
    }
}

// Find Note by ID
function findNoteById(noteId) {
    for (const category in allNotes) {
        const note = allNotes[category].find(n => n.id === noteId);
        if (note) return note;
    }
    return null;
}

// Filter Notes
function filterNotes(query) {
    if (!query) {
        filteredNotes = JSON.parse(JSON.stringify(allNotes));
    } else {
        filteredNotes = {};
        for (const category in allNotes) {
            filteredNotes[category] = allNotes[category].filter(note =>
                note.title.toLowerCase().includes(query) ||
                note.content.toLowerCase().includes(query) ||
                note.tags.some(tag => tag.toLowerCase().includes(query))
            );
        }
    }
    
    renderCategory(currentCategory);
    
    // Attach tag listeners after rendering
    setTimeout(attachTagListeners, 100);
    
    // Show search result count
    if (query) {
        updateSearchResultCount(query);
    }
}

// Update search result count
function updateSearchResultCount(query) {
    const totalResults = Object.values(filteredNotes).reduce((sum, notes) => sum + notes.length, 0);
    
    if (totalResults > 0) {
        showNotification(`找到 ${totalResults} 個相關筆記`, 1500);
    } else {
        showNotification('沒有找到相關筆記', 2000);
    }
}

// Format Markdown-like Content with Multimedia Support
function formatMarkdownWithCollapse(content, noteId) {
    let html = escapeHtml(content);
    
    // Process multimedia content first
    html = processMultimedia(html);
    
    // Headers with typography hierarchy
    html = html.replace(/^# (.*$)/gm, '<h1 class="header-h1">$1</h1>');
    html = html.replace(/^## (.*$)/gm, '<h2 class="header-h2">$1</h2>');
    html = html.replace(/^### (.*$)/gm, '<h3 class="header-h3">$1</h3>');
    html = html.replace(/^#### (.*$)/gm, '<h3 class="header-h3">$1</h3>');
    html = html.replace(/^##### (.*$)/gm, '<h3 class="header-h3">$1</h3>');
    
    // Bold text
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Lists
    html = html.replace(/^- (.*$)/gm, '<li>$1</li>');
    html = html.replace(/^(\d+)\. (.*$)/gm, '<li>$2</li>');
    
    // Wrap consecutive list items in ul
    html = html.replace(/(<li>.*?<\/li>(\s*\n)*)+/gs, (match) => {
        return '<ul>' + match.trim() + '</ul>\n';
    });
    
    // Line breaks to paragraphs
    html = html.replace(/\n\n+/g, '</p><p>');
    html = html.replace(/\n/g, '<br>');
    
    // Wrap in paragraphs if not already wrapped
    if (!html.startsWith('<h1>') && !html.startsWith('<h2>') && !html.startsWith('<h3>') && 
        !html.startsWith('<ul>') && !html.startsWith('<div class="multimedia-content">')) {
        html = '<p>' + html + '</p>';
    }
    
    // Clean up empty paragraphs
    html = html.replace(/<p><\/p>/g, '');
    html = html.replace(/<p>(\s*<br>\s*)*<\/p>/g, '');
    
    return html;
}

// Process Multimedia Content
function processMultimedia(html) {
    // Process images
    html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, alt, src) => {
        return `<div class="multimedia-content">
            <span class="media-icon">🖼️</span>
            <p><strong>圖片: ${alt || 'Image'}</strong></p>
            <a href="${src}" target="_blank">查看圖片</a>
        </div>`;
    });
    
    // Process YouTube videos
    html = html.replace(/\[youtube:([^\]]+)\]/g, (match, videoId) => {
        return `<div class="multimedia-content">
            <span class="media-icon">📺</span>
            <p><strong>YouTube 影片</strong></p>
            <a href="https://www.youtube.com/watch?v=${videoId}" target="_blank">觀看影片</a>
        </div>`;
    });
    
    // Process PDF files
    html = html.replace(/\[file:([^\]]+)\]\(([^)]+)\)/g, (match, fileName, fileUrl) => {
        const fileIcon = fileName.toLowerCase().includes('.pdf') ? '📄' : 
                        fileName.toLowerCase().includes('.doc') ? '📝' : '📁';
        return `<div class="multimedia-content">
            <span class="media-icon">${fileIcon}</span>
            <p><strong>檔案: ${fileName}</strong></p>
            <a href="${fileUrl}" target="_blank">下載檔案</a>
        </div>`;
    });
    
    // Process audio files
    html = html.replace(/\[audio:([^\]]+)\]\(([^)]+)\)/g, (match, audioName, audioUrl) => {
        return `<div class="multimedia-content">
            <span class="media-icon">🎵</span>
            <p><strong>音頻: ${audioName}</strong></p>
            <a href="${audioUrl}" target="_blank">播放音頻</a>
        </div>`;
    });
    
    return html;
}

// Escape HTML
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// Show Notification
function showNotification(message, duration = 2000) {
    if (!copyNotification) return;
    
    const messageSpan = copyNotification.querySelector('.notification-text');
    if (messageSpan) {
        messageSpan.textContent = message;
    } else {
        // If notification structure is different, update it directly
        copyNotification.innerHTML = `
            <span class="notification-icon">✅</span>
            <span class="notification-text">${message}</span>
        `;
    }
    
    // Make sure notification is visible
    copyNotification.classList.remove('hidden');
    copyNotification.style.opacity = '1';
    copyNotification.style.transform = 'translateX(0)';
    
    // Hide after duration
    setTimeout(() => {
        copyNotification.classList.add('hidden');
        copyNotification.style.opacity = '0';
        copyNotification.style.transform = 'translateX(100%)';
    }, duration);
}

// Create Floating Particles
function createFloatingParticles() {
    const particlesContainer = document.querySelector('.floating-particles');
    if (!particlesContainer) return;
    
    // Create additional particles dynamically
    for (let i = 0; i < 8; i++) {
        const particle = document.createElement('div');
        particle.style.cssText = `
            position: absolute;
            width: ${2 + Math.random() * 4}px;
            height: ${2 + Math.random() * 4}px;
            background: var(--cyber-primary);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--cyber-glow);
            animation: float ${4 + Math.random() * 4}s ease-in-out infinite;
            animation-delay: ${-Math.random() * 8}s;
            top: ${Math.random() * 100}%;
            left: ${Math.random() * 100}%;
            opacity: ${0.2 + Math.random() * 0.6};
        `;
        particlesContainer.appendChild(particle);
    }
}

// Add smooth transitions between categories
function addTransitionEffects() {
    const style = document.createElement('style');
    style.id = 'transition-effects';
    style.textContent = `
        .category-content {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s ease-out;
        }
        
        .category-content.active {
            opacity: 1;
            transform: translateY(0);
        }
        
        .note-card {
            transform: translateY(10px);
            opacity: 0;
            animation: slideInUp 0.3s ease-out forwards;
        }
        
        @keyframes slideInUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes ripple {
            to {
                transform: scale(2);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
}

// Add visual feedback for interactions
document.addEventListener('click', (e) => {
    if (e.target.closest('.tab-button, .action-btn, .add-note-btn')) {
        // Create ripple effect
        const button = e.target.closest('.tab-button, .action-btn, .add-note-btn');
        const ripple = document.createElement('div');
        
        const rect = button.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;
        
        ripple.style.cssText = `
            position: absolute;
            width: ${size}px;
            height: ${size}px;
            left: ${x}px;
            top: ${y}px;
            background: var(--cyber-glow);
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 0.6s ease-out;
            pointer-events: none;
            z-index: 1;
        `;
        
        button.style.position = 'relative';
        button.style.overflow = 'hidden';
        button.appendChild(ripple);
        
        setTimeout(() => {
            ripple.remove();
        }, 600);
    }
});

// Easter egg: Konami code
let konamiCode = [];
const konamiSequence = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'KeyB', 'KeyA'];

document.addEventListener('keydown', (e) => {
    konamiCode.push(e.code);
    if (konamiCode.length > konamiSequence.length) {
        konamiCode.shift();
    }
    
    if (JSON.stringify(konamiCode) === JSON.stringify(konamiSequence)) {
        showNotification('🎮 Konami Code activated! 加油溫書！DSE必勝！', 4000);
        document.body.style.animation = 'cyberGlow 0.5s ease-in-out 3';
        konamiCode = [];
        
        // Add special effects
        const specialEffect = document.createElement('div');
        specialEffect.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, 
                rgba(0,255,255,0.1) 0%, 
                rgba(0,102,255,0.1) 50%, 
                rgba(102,204,255,0.1) 100%);
            animation: specialGlow 2s ease-in-out;
            pointer-events: none;
            z-index: 9999;
        `;
        
        if (!document.getElementById('special-style')) {
            const specialStyle = document.createElement('style');
            specialStyle.id = 'special-style';
            specialStyle.textContent = `
                @keyframes specialGlow {
                    0%, 100% { opacity: 0; }
                    50% { opacity: 1; }
                }
            `;
            document.head.appendChild(specialStyle);
        }
        
        document.body.appendChild(specialEffect);
        
        setTimeout(() => {
            specialEffect.remove();
        }, 2000);
    }
});
